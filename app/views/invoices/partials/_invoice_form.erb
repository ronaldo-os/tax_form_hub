<div class="container mt-5">
  <div class="card shadow-sm mb-10">
    <div class="card-body">
      <%= form_with model: @invoice, local: true, html: { multipart: true, class: "" } do |f| %>

        <h5 class="text-secondary">Invoice Details</h5>
        
        <div class="row">

          <div class="col-md-6 mb-3">
            <%= f.label :To, class: "form-label" %>
            <%= select_tag "invoice[recipient_company_id]",
                options_for_select(
                  @recipient_companies.map { |c|
                    [
                      c.name,
                      c.id,
                      {
                        'data-name': c.name,
                        'data-website': c.website,
                        'data-industry': c.industry,
                        'data-ownership': c.ownership,
                        'data-address': c.address,
                        'data-phone': c.phone,
                        'data-description': c.description,
                        'data-size': c.size,
                        'data-share-capital': c.share_capital,
                        'data-registration-address': c.registration_address,
                        'data-email-address': c.email_address,
                        'data-company-id-type': c.company_id_type,
                        'data-company-id-number': c.company_id_number,
                        'data-tax-id-type': c.tax_id_type,
                        'data-tax-id-number': c.tax_id_number,
                        'data-internal-identifier': c.internal_identifier
                      }
                    ]
                  },
                  @invoice.recipient_company_id
                ),
                prompt: "Select a company",
                class: "form-select",
                id: "recipient_company_id",
                required: true
              %>


            <!-- Company preview will be inserted here -->
            <div id="recipient-preview" class="p-3 rounded border bg-light-subtle d-none">
              <h6 class="fw-bold mb-2" id="company_name"></h6>
              <p class="mb-1 text-muted" id="company_address"></p>
              <p class="mb-1 text-muted" id="company_location"></p>
              <p class="mb-1 text-muted" id="company_country"></p>
              <hr>
              <p class="mb-1 small"><strong id="company_number"></strong></p>
              <p class="mb-0 small"><strong id="company_tax_number"></strong></p>

              <a href="#" class="text-primary small d-block mt-2" id="change-recipient">
                Change recipient
              </a>
            </div>
          </div>


          <div class="col-md-6">


            <%= f.label :invoice_number, class: "form-label" %>
            <%= f.text_field :invoice_number, class: "form-control", required: true %>

            <div class="row mt-3">
              <div class="col-md-6">
                <%= f.label :issue_date, class: "form-label" %>
                <%= f.date_field :issue_date, class: "form-control", value: f.object.issue_date || Date.today %>
              </div>


              <div class="col-md-6">
                <%= f.label :currency, class: "form-label" %>
                <%= f.select :currency, 
                  options_for_select(
                    [["PHP - Philippine Peso", "PHP"], ["USD - US Dollar", "USD"], ["EUR - Euro", "EUR"], ["JPY - Japanese Yen", "JPY"]],
                    f.object.currency.presence || "PHP"
                  ), 
                  { prompt: "Select Currency" }, 
                  class: "form-control" %>
              </div>
            </div>

            <div id="invoice_details_parent_div" class="mt-3">
              <div id="optional_fields_container" data-invoice-info='<%= @invoice.invoice_info.to_json %>'>
                <% unless action_name == "edit" %>
                <% invoice_info = @invoice.invoice_info || {} %>

                <% unless invoice_info.key?("Payment_Due_Date.pament_due_date.date.12") %>
                  <div class="mb-3 position-relative border rounded p-3 pt-3" data-optional-group="PaymentDueDate">
                    <button type="button" class="btn btn-sm btn-outline-danger rounded position-absolute top-0 end-0 m-2 remove-group">×</button>
                    <div class="row">
                      <div class="col-md-12">
                        <%= f.label :payment_due_date, class: "form-label" %>
                        <%= f.date_field :payment_due_date, name: "Payment_Due_Date.pament_due_date.date.12", class: "form-control" %>
                      </div>
                    </div>
                  </div>
                <% end %>

                <% unless invoice_info.key?("Delivery_Date.delivery_date.date.12") %>
                  <div class="mb-3 position-relative border rounded p-3 pt-3" data-optional-group="DeliveryDate">
                    <button type="button" class="btn btn-sm btn-outline-danger rounded position-absolute top-0 end-0 m-2 remove-group">×</button>
                    <div class="row">
                      <div class="col-md-12">
                        <%= f.label :delivery_date, class: "form-label" %>
                        <%= f.date_field :delivery_date, name: "Delivery_Date.delivery_date.date.12", class: "form-control" %>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>

              </div>
                <div class="mt-4 mb-4">
                  <select id="optionalField" class="form-select invoice_info_select">
                  </select>
                </div>
              </div>

          </div>

        </div>

      <table class="table text-center align-middle invoice-table">
        <thead class="table-light">
          <tr>
            <th></th>
            <th>Item ID</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Price per unit</th>
            <th>Tax (%)</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="line-items" data-line-items='<%= raw(@invoice.line_items_data.to_json) %>'>
          <% unless action_name == "edit" %>
            <% unless params[:template_id].present? %>
              <tr class="line-item" data-line-index="0" test>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-primary toggle-dropdown">+</button>
                </td>

                <td><input type="text" name="invoice[line_items_attributes][0][item_id]" class="form-control item-id" required></td>
                <td><input type="text" name="invoice[line_items_attributes][0][description]" class="form-control description" required></td>
                <td><input type="number" name="invoice[line_items_attributes][0][quantity]" class="form-control quantity" value="1" required></td>
                <td><input type="text" name="invoice[line_items_attributes][0][unit]" class="form-control unit" value="pcs" required></td>
                <td><input type="number" step="0.01" name="invoice[line_items_attributes][0][price]" class="form-control price" required></td>
                <td><input type="number" step="0.01" name="invoice[line_items_attributes][0][tax]" class="form-control tax" required></td>
                <td class="text-end total">0.00</td>
                <td>
                  <input type="hidden" name="invoice[line_items_attributes][0][total]" value="0.00">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-line">&minus;</button>
                </td>
              </tr>

              <tr class="dropdown_per_line hidden" data-line-index="0">
                <td colspan="3">
                  <select name="additional_field_0" id="additional_field_0" class="no-label form-select"></select>
                </td>
                <td colspan="6"></td>
              </tr>
            <% end %>
          <% end %>
      </table>


      <!-- Action buttons -->
      <div class="row g-2 mb-4">
        <div class="col-md-4 d-grid">
          <button type="button" id="add-discount-row" class="btn btn-outline-primary btn-sm">
            Add Charge / Discount
          </button>
        </div>
        <div class="col-md-4 d-grid">
          <button type="button" id="add-base-quantity" class="btn btn-outline-secondary btn-sm">
            Show Base Quantity
          </button>
        </div>
        <div class="col-md-4 d-grid">
          <button type="button" id="add-line" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg me-1"></i> Add Line
          </button>
        </div>
      </div>

      <!-- Totals -->
      <div class="card border-0 shadow-sm p-3 text-end">
        <p class="mb-1">Subtotal excl. taxes: <strong><span class="subtotal-amount">0.00</span></strong></p>
        <p class="mb-1">Total taxes: <strong><span class="total-tax-amount">0.00</span> <span class="currency_type">PHP</span></strong></p>
        <hr>
        <h5 class="fw-bold">Grand Total <span class="currency_type">PHP</span>: 
          <span class="grand-total-amount text-primary">0.00</span>
        </h5>
      </div>

        <hr>

        <div class="row">
          <div class="col-md-6">
            <div id="payment_terms_parent_div">
            </div>
            <select name="payment_terms_select" id="payment_terms_select" class="form-select mb-3" data-optional-group="0">
              <option value="">Add payment terms and means</option>
              <option value="cash">Cash payment</option>
              <option value="check">Check</option>
              <option value="bank">Bank Account</option>
              <option value="bank_card">Bank Card</option>
              <option value="debit">Direct Debit</option>
              <option value="bic_iban">BIC + IBAN</option>
            </select>
            <div class="form-check mb-4">
              <%= f.check_box :save_payment_terms_for_future,
                    class: "form-check-input",
                    checked: ( @save_payment_terms_for_future.present? ||
                      (@invoice.persisted? && @invoice.save_payment_terms_for_future?) ||
                      (!@invoice.persisted? && @payment_terms.present?)
                    ) %>
              <%= f.label :save_payment_terms_for_future, "Save payment terms and means for future invoices", class: "form-check-label" %>
            </div>

            <hr>

            <button type="button" class="btn btn-primary btn-sm w-100"
              data-bs-toggle="collapse"
              data-bs-target="#delivery_details_parent_div"
              aria-expanded="false"
              aria-controls="delivery_details_parent_div">
              + Delivery Details
            </button>

            <div class="collapse mt-3 border rounded p-3 pt-3" id="delivery_details_parent_div">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Delivery details</h5>
              </div>

              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Country/Region</label>
                  <select name="invoice[delivery_details_country]" id="initial_delivery_details_country" class="form-select">
                    <% if @invoice&.delivery_details_country.present? %>
                      <option value="<%= @invoice.delivery_details_country %>" selected><%= @invoice.delivery_details_country %></option>
                    <% else %>
                      <option value="">Select country</option>
                    <% end %>
                  </select>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Postbox</label>
                  <input type="text" name="invoice[delivery_details_postbox]" class="form-control" value="<%= @invoice&.delivery_details_postbox %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Street</label>
                  <input type="text" name="invoice[delivery_details_street]" class="form-control" value="<%= @invoice&.delivery_details_street %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Number</label>
                  <input type="text" name="invoice[delivery_details_number]" class="form-control" value="<%= @invoice&.delivery_details_number %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Locality name</label>
                  <input type="text" name="invoice[delivery_details_locality_name]" class="form-control" value="<%= @invoice&.delivery_details_locality_name %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Postal/ZIP</label>
                  <input type="text" name="invoice[delivery_details_zip_code]" class="form-control" value="<%= @invoice&.delivery_details_zip_code %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">City</label>
                  <input type="text" name="invoice[delivery_details_city]" class="form-control" value="<%= @invoice&.delivery_details_city %>">
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">GLN</label>
                  <input type="text" name="invoice[delivery_details_gln]" class="form-control" value="<%= @invoice&.delivery_details_gln %>">
                  <div class="form-text">
                    <a href="https://en.wikipedia.org/wiki/Global_Location_Number" target="_blank">What is a GLN?</a>
                  </div>
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Company Name</label>
                  <input type="text" name="invoice[delivery_details_company_name]" class="form-control" value="<%= @invoice&.delivery_details_company_name %>">
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Tax ID</label>
                  <select name="invoice[delivery_details_tax_id]" class="form-select">
                    <option value="">Tax ID</option>
                    <% tax_id_options = [
                      "AE:TRN", "AO:VAT", "AR:CUIT", "AT:MWST", "AU:TFN", "BB:TIN", "BD:TIN", "BE:BTW", "BF:IFU", "BG:DDS",
                      "BH:TIN", "BJ:IFU", "BR:CNPJ", "BW:VAT", "CA:GST", "CA:QST", "CD:VAT", "CG:VAT", "CH:UID", "CI:VAT",
                      "CL:RUT", "CM:VAT", "CN:VAT", "CO:NIT", "CR:CJ", "CY:FPA", "CZ:DPH", "DE:MWST", "DK:CVR", "DZ:NIF",
                      "EC:RUC", "EE:KMKR", "EG:TIN", "ES:IVA", "FI:ALV", "FR:VAT", "GB:VAT", "GH:VAT", "GQ:VAT", "GR:FPA",
                      "GT:NIT", "HR:OIB", "HU:AFA", "ID:VAT", "IE:VAT", "IL:VAT", "IN:GST", "IS:VSK", "IT:IVA", "JP:CT",
                      "JP:VAT", "KE:VAT", "KR:VAT", "KW:TIN", "LI:VAT", "LK:TIN", "LT:PVM", "LU:TVA", "LV:VAT", "MA:IF",
                      "MC:TVA", "MU:TAN", "MX:RFC", "MY:GST", "MY:SST", "MY:TIN", "MY:TTX", "NG:TIN", "NL:BTW", "NO:VAT",
                      "NZ:GST", "PE:RUC", "PK:NTN", "PL:NIP", "PR:EIN", "PT:NIF", "QA:TIN", "RO:CIF", "RW:TIN", "SA:TIN",
                      "SE:VAT", "SG:GSTN", "SI:DDV", "SK:DPH", "SZ:VAT", "TD:VAT", "TH:VAT", "TN:TVA", "TR:VKN", "TS:VAT",
                      "TW:GUI", "TW:TIN", "UG:VAT", "US:EIN", "UY:RUT", "VE:RIF", "ZA:VAT", "ZW:VAT"
                    ] %>

                    <% tax_id_options.each do |code| %>
                      <option value="<%= code %>" <%= "selected" if @invoice.delivery_details_tax_id == code %>><%= code %></option>
                    <% end %>
                  </select>
                </div>


                <div class="col-md-8 mb-3">
                  <label class="form-label">Tax Number</label>
                  <input type="text" name="invoice[delivery_details_tax_number]" class="form-control" value="<%= @invoice&.delivery_details_tax_number %>">
                </div>
              </div>
            </div>


            <%= render partial: "invoices/partials/create_invoice_location_selector",
            locals: {
            type: "Ship From",
            locations: @locations_by_type["Ship From"] || [],
            selected_location_id: @invoice.ship_from_location_id
            } %>

            <%= render partial: "invoices/partials/create_invoice_location_selector",
            locals: {
            type: "Remit To",
            locations: @locations_by_type["Remit To"] || [],
            selected_location_id: @invoice.remit_to_location_id
            } %>

            <%= render partial: "invoices/partials/create_invoice_location_selector",
            locals: {
            type: "Tax Representative",
            locations: @locations_by_type["Tax Representative"] || [],
            selected_location_id: @invoice.tax_representative_location_id
            } %>


          </div>
          
          <div class="col-md-6">
            <div class="mb-3">
              <%= f.label :recipient_note, "Write a message to the recipient", class: "form-label" %>
              <%= f.text_area :recipient_note, class: "form-control", rows: 5, placeholder: "Enter your message...", value: @recipient_note.presence || @invoice&.recipient_note %>
            </div>

            <div class="form-check mb-4">
              <%= f.check_box :save_notes_for_future,
                    class: "form-check-input",
                    checked: ( @save_notes_for_future.present? ||
                      (@invoice.persisted? && @invoice.save_notes_for_future?) ||
                      (!@invoice.persisted? && @recipient_note.present?)
                    ) %>
              <%= f.label :save_notes_for_future, "Save notes for future Invoices", class: "form-check-label" %>
            </div>

            <div class="mb-3">
              <%= f.label :attachments, class: "form-label" %>
              <%= f.file_field :attachments, 
                    class: "form-control", 
                    multiple: true, 
                    accept: "image/*,application/pdf", 
                    id: "attachments" %>
              <div id="fileHelp" class="form-text">Only images (JPEG, PNG, GIF) and PDFs allowed. Max file size: 10 MB.</div>
              <div id="fileError" class="text-danger small mt-1"></div>
            </div>

            <% if @invoice.attachments.attached? %>
              <div class="mb-3">
                <label class="form-label">Existing Attachments</label>
                <div class="row">
                  <% @invoice.attachments.each_with_index do |attachment, index| %>
                    <div class="col-md-6 mb-2">
                      <div class="border p-2 rounded bg-light text-center">

                        <div class="mx-auto mb-2 rounded overflow-hidden"
                            style="width: 170px; height: 170px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9;">
                          <% if attachment.content_type.start_with?("image/") %>
                            <% begin %>
                              <%= image_tag attachment.variant(resize_to_limit: [200, 200]).processed,
                                    style: "max-width: 170px; max-height: 170px; object-fit: contain;",
                                    class: "d-block",
                                    alt: attachment.filename.to_s %>
                            <% rescue => e %>
                              <span class="text-danger small">Image preview failed</span>
                            <% end %>
                          <% else %>
                            <%= link_to attachment.filename.to_s,
                                  url_for(attachment),
                                  target: "_blank",
                                  class: "text-truncate small text-primary" %>
                          <% end %>
                        </div>

                        <div class="btn-group" role="group" aria-label="Remove Attachment Toggle" style="width: 170px;">
                          <input type="checkbox"
                                class="btn-check"
                                name="invoice[remove_attachment_ids][]"
                                value="<%= attachment.id %>"
                                id="remove_attachment_<%= index %>"
                                autocomplete="off">
                          <label class="btn btn-outline-danger" for="remove_attachment_<%= index %>">Remove</label>
                        </div>


                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>



          </div>
        </div>

        <nav class="navbar navbar-light bg-light fixed-bottom border-top shadow-sm py-2" id="form_actions_fixed_navbar">
          <div class="container d-flex justify-content-between">
            
            <!-- Left side -->
            <div class="d-flex gap-2">
              <% if action_name != "edit" %>
                <%= link_to "Discard", invoices_path, 
                    class: "btn btn-secondary btn-md discard-btn", 
                    data: { confirm: "Are you sure you want to discard this invoice?" } %>

                <%= f.submit "Save As Draft", class: "btn btn-secondary btn-md" %>
              <% else %>
                <%= link_to "Back", invoices_path, class: "btn btn-secondary btn-md" %>
              <% end %>
            </div>

            <!-- Right side -->
            <div>
              <% if action_name != "edit" %>
                <%= f.submit "Send",
                    class: "btn btn-primary btn-md",
                    formaction: create_and_send_invoices_path,
                    formmethod: :post,
                    id: "send_invoice_btn" %>
              <% else %>
                <%= button_tag "Update", type: "submit", name: "commit_action", value: "save", class: "btn btn-primary" %>
                <%= button_tag "Send", type: "submit", name: "commit_action", value: "send", class: "btn btn-success" %>
              <% end %>
              

            </div>
            
          </div>
        </nav>



        <div id="hidden_fields_container" class="d-none">
            <%= f.hidden_field :total, id: 'total_amount_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :price_adjustments, value: @invoice.price_adjustments.to_json.html_safe, id: 'price_adjustments_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :payment_terms, value: (@invoice.payment_terms.to_h.merge(@payment_terms.to_h)).to_json.html_safe, id: 'payment_terms_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :invoice_info, value: @invoice.invoice_info.to_json.html_safe, id: 'optional_fields_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :ship_from_location_id, id: "ship_from_location_id", data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :remit_to_location_id, id: "remit_to_location_id", data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :tax_representative_location_id, id: "tax_representative_location_id", data: { field_type: 'invoice_form_fields' } %>

            <%= hidden_field_tag :payment_terms_json_edit, (@invoice.payment_terms.to_h.merge(@payment_terms.to_h)).to_json.html_safe, id: 'payment_terms_json_edit', data: { field_type: 'invoice_form_fields' } %>
            <%= hidden_field_tag :price_adjustments_json_edit, @invoice.price_adjustments.to_json.html_safe, id: 'price_adjustments_json_edit', data: { field_type: 'invoice_form_fields' } %>
        </div>
    </div>
    <div class="card-footer bg-white pb-3">
        <button type="button" class="btn btn-primary btn-sm add-footer-toggle-btn mt-3">
          + Add footer notes
        </button>

        <div id="footer_wrapper_parent_div" class="mt-3" style="display:none">
          <div class="mb-3">
              <%= f.label :footer_notes, class: "form-label" %>
              <%= f.text_area :footer_notes, class: "form-control", rows: 5, placeholder: "Enter your message...", value: @footer_notes.presence || @invoice&.footer_notes %>
            </div>

            <div class="form-check mb-4">
              <%= f.check_box :save_footer_notes_for_future,
                    class: "form-check-input",
                    checked: ( @save_footer_notes_for_future.present? ||
                      (@invoice.persisted? && @invoice.save_footer_notes_for_future?) ||
                      (!@invoice.persisted? && defined?(@footer_notes) && @footer_notes.present?)
                    ) %>
              <%= f.label :save_footer_notes_for_future, "Save notes for future Invoices", class: "form-check-label" %>
            </div>
        </div>
    </div>
    <% end %>
  </div>
</div>
