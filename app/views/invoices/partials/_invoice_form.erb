<div class="container mt-5">
  <div class="card shadow-sm mb-10">
    <div class="card-body">
      <%= form_with model: @invoice, local: true, html: { multipart: true, class: "" } do |f| %>

        <h5 class="text-secondary">Invoice Details</h5>
        
        <div class="row">

          <div class="col-md-6 mb-3">
            <%= f.label :To, class: "form-label" %>
            <%= select_tag "invoice[recipient_company_id]",
                options_for_select(
                  @recipient_companies.map { |c|
                    [
                      c.name,
                      c.id,
                      {
                        'data-name': c.name,
                        'data-website': c.website,
                        'data-industry': c.industry,
                        'data-ownership': c.ownership,
                        'data-address': c.address,
                        'data-phone': c.phone,
                        'data-description': c.description,
                        'data-size': c.size,
                        'data-share-capital': c.share_capital,
                        'data-registration-address': c.registration_address,
                        'data-email-address': c.email_address,
                        'data-company-id-type': c.company_id_type,
                        'data-company-id-number': c.company_id_number,
                        'data-tax-id-type': c.tax_id_type,
                        'data-tax-id-number': c.tax_id_number,
                        'data-internal-identifier': c.internal_identifier
                      }
                    ]
                  },
                  @invoice.recipient_company_id
                ),
                prompt: "Select a company",
                class: "form-select",
                id: "recipient_company_id",
                required: true
              %>


            <!-- Company preview will be inserted here -->
            <div id="recipient-preview" class="p-3 rounded border bg-light-subtle d-none">
              <h6 class="fw-bold mb-2" id="company_name"></h6>
              <p class="mb-1 text-muted" id="company_address"></p>
              <p class="mb-1 text-muted" id="company_location"></p>
              <p class="mb-1 text-muted" id="company_country"></p>
              <hr>
              <p class="mb-1 small"><strong id="company_number"></strong></p>
              <p class="mb-0 small"><strong id="company_tax_number"></strong></p>

              <a href="#" class="text-primary small d-block mt-2" id="change-recipient">
                Change recipient
              </a>
            </div>
          </div>


          <div class="col-md-6">


            <%= f.label :invoice_number, class: "form-label" %>
            <%= f.text_field :invoice_number, class: "form-control", required: true %>

            <div class="row mt-3">
              <div class="col-md-6">
                <%= f.label :issue_date, class: "form-label" %>
                <%= f.date_field :issue_date, class: "form-control", value: f.object.issue_date || Date.today %>
              </div>


              <div class="col-md-6">
                <%= f.label :currency, class: "form-label" %>
                <%= f.select :currency, 
                  options_for_select(
                    [["PHP - Philippine Peso", "PHP"], ["USD - US Dollar", "USD"], ["EUR - Euro", "EUR"], ["JPY - Japanese Yen", "JPY"]],
                    f.object.currency.presence || "PHP"
                  ), 
                  { prompt: "Select Currency" }, 
                  class: "form-control" %>
              </div>
            </div>

            <div id="invoice_details_parent_div" class="mt-3">
              <div id="optional_fields_container" data-invoice-info='<%= @invoice.invoice_info.to_json %>'>
                <% unless action_name == "edit" %>
                <% invoice_info = @invoice.invoice_info || {} %>

                <% unless invoice_info.key?("Payment_Due_Date.pament_due_date.date.12") %>
                  <div class="mb-3 position-relative border rounded p-3 pt-3" data-optional-group="PaymentDueDate">
                    <button type="button" class="btn btn-sm btn-outline-danger rounded position-absolute top-0 end-0 m-2 remove-group">×</button>
                    <div class="row">
                      <div class="col-md-12">
                        <%= f.label :payment_due_date, class: "form-label" %>
                        <%= f.date_field :payment_due_date, name: "Payment_Due_Date.pament_due_date.date.12", class: "form-control" %>
                      </div>
                    </div>
                  </div>
                <% end %>

                <% unless invoice_info.key?("Delivery_Date.delivery_date.date.12") %>
                  <div class="mb-3 position-relative border rounded p-3 pt-3" data-optional-group="DeliveryDate">
                    <button type="button" class="btn btn-sm btn-outline-danger rounded position-absolute top-0 end-0 m-2 remove-group">×</button>
                    <div class="row">
                      <div class="col-md-12">
                        <%= f.label :delivery_date, class: "form-label" %>
                        <%= f.date_field :delivery_date, name: "Delivery_Date.delivery_date.date.12", class: "form-control" %>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>

              </div>
                <div class="mt-4 mb-4">
                  <select id="optionalField" class="form-select invoice_info_select">
                  </select>
                </div>
              </div>

          </div>

        </div>

      <table class="table text-center align-middle invoice-table">
        <thead class="table-light">
          <tr>
            <th></th>
            <th>Item ID</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Price per unit</th>
            <th>Tax (%)</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="line-items" data-line-items='<%= raw(@invoice.line_items_data.to_json) %>'>
          <% unless action_name == "edit" %>
            <% unless params[:template_id].present? %>
              <tr class="line-item" data-line-index="0" test>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-primary toggle-dropdown">+</button>
                </td>

                <td><input type="text" name="invoice[line_items_attributes][0][item_id]" class="form-control item-id" required></td>
                <td><input type="text" name="invoice[line_items_attributes][0][description]" class="form-control description" required></td>
                <td><input type="number" name="invoice[line_items_attributes][0][quantity]" class="form-control quantity" value="1" required></td>
                <td><input type="text" name="invoice[line_items_attributes][0][unit]" class="form-control unit" value="pcs" required></td>
                <td><input type="number" step="0.01" name="invoice[line_items_attributes][0][price]" class="form-control price" required></td>
                <td><input type="number" step="0.01" name="invoice[line_items_attributes][0][tax]" class="form-control tax" required></td>
                <td class="text-end total">0.00</td>
                <td>
                  <input type="hidden" name="invoice[line_items_attributes][0][total]" value="0.00">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-line">&minus;</button>
                </td>
              </tr>

              <tr class="dropdown_per_line hidden" data-line-index="0">
                <td colspan="3">
                  <select name="additional_field_0" id="additional_field_0" class="no-label form-select"></select>
                </td>
                <td colspan="6"></td>
              </tr>
            <% end %>
          <% end %>
      </table>


      <!-- Action buttons -->
      <div class="row g-2 mb-4">
        <div class="col-md-4 d-grid">
          <button type="button" id="add-discount-row" class="btn btn-outline-primary btn-sm">
            Add Charge / Discount
          </button>
        </div>
        <div class="col-md-4 d-grid">
          <button type="button" id="add-base-quantity" class="btn btn-outline-secondary btn-sm">
            Show Base Quantity
          </button>
        </div>
        <div class="col-md-4 d-grid">
          <button type="button" id="add-line" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg me-1"></i> Add Line
          </button>
        </div>
      </div>

      <!-- Totals -->
      <div class="card border-0 shadow-sm p-3 text-end">
        <p class="mb-1">Subtotal excl. taxes: <strong><span class="subtotal-amount">0.00</span></strong></p>
        <p class="mb-1">Total taxes: <strong><span class="total-tax-amount">0.00</span> <span class="currency_type">PHP</span></strong></p>
        <hr>
        <h5 class="fw-bold">Grand Total <span class="currency_type">PHP</span>: 
          <span class="grand-total-amount text-primary">0.00</span>
        </h5>
      </div>

        <hr>

        <div class="row">
          <div class="col-md-6">
            <div id="payment_terms_parent_div">
            </div>
            <select name="payment_terms_select" id="payment_terms_select" class="form-select mb-3" data-optional-group="0">
              <option value="">Add payment terms and means</option>
              <option value="cash">Cash payment</option>
              <option value="check">Check</option>
              <option value="bank">Bank Account</option>
              <option value="bank_card">Bank Card</option>
              <option value="debit">Direct Debit</option>
              <option value="bic_iban">BIC + IBAN</option>
            </select>
            <div class="form-check mb-4">
              <%= f.check_box :save_payment_terms_for_future,
                    class: "form-check-input",
                    checked: ( @save_payment_terms_for_future.present? ||
                      (@invoice.persisted? && @invoice.save_payment_terms_for_future?) ||
                      (!@invoice.persisted? && @payment_terms.present?)
                    ) %>
              <%= f.label :save_payment_terms_for_future, "Save payment terms and means for future invoices", class: "form-check-label" %>
            </div>

            <hr>

            <button type="button" class="btn btn-primary btn-sm w-100"
              data-bs-toggle="collapse"
              data-bs-target="#delivery_details_parent_div"
              aria-expanded="false"
              aria-controls="delivery_details_parent_div">
              + Delivery Details
            </button>

            <div class="collapse mt-3 border rounded p-3 pt-3" id="delivery_details_parent_div">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Delivery details</h5>
              </div>

              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Country/Region</label>
                  <select name="invoice[delivery_details_country]" id="initial_delivery_details_country" class="form-select">
                    <% if @invoice&.delivery_details_country.present? %>
                      <option value="<%= @invoice.delivery_details_country %>" selected><%= @invoice.delivery_details_country %></option>
                    <% else %>
                      <option value="">Select country</option>
                    <% end %>
                  </select>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Postbox</label>
                  <input type="text" name="invoice[delivery_details_postbox]" class="form-control" value="<%= @invoice&.delivery_details_postbox %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Street</label>
                  <input type="text" name="invoice[delivery_details_street]" class="form-control" value="<%= @invoice&.delivery_details_street %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Number</label>
                  <input type="text" name="invoice[delivery_details_number]" class="form-control" value="<%= @invoice&.delivery_details_number %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Locality name</label>
                  <input type="text" name="invoice[delivery_details_locality_name]" class="form-control" value="<%= @invoice&.delivery_details_locality_name %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Postal/ZIP</label>
                  <input type="text" name="invoice[delivery_details_zip_code]" class="form-control" value="<%= @invoice&.delivery_details_zip_code %>">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">City</label>
                  <input type="text" name="invoice[delivery_details_city]" class="form-control" value="<%= @invoice&.delivery_details_city %>">
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">GLN</label>
                  <input type="text" name="invoice[delivery_details_gln]" class="form-control" value="<%= @invoice&.delivery_details_gln %>">
                  <div class="form-text">
                    <a href="https://en.wikipedia.org/wiki/Global_Location_Number" target="_blank">What is a GLN?</a>
                  </div>
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Company Name</label>
                  <input type="text" name="invoice[delivery_details_company_name]" class="form-control" value="<%= @invoice&.delivery_details_company_name %>">
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Tax ID</label>
                  <select name="invoice[delivery_details_tax_id]" class="form-select">
                    <option value="">Tax ID</option>
                    <% tax_id_options = [
                      "AE:TRN", "AO:VAT", "AR:CUIT", "AT:MWST", "AU:TFN", "BB:TIN", "BD:TIN", "BE:BTW", "BF:IFU", "BG:DDS",
                      "BH:TIN", "BJ:IFU", "BR:CNPJ", "BW:VAT", "CA:GST", "CA:QST", "CD:VAT", "CG:VAT", "CH:UID", "CI:VAT",
                      "CL:RUT", "CM:VAT", "CN:VAT", "CO:NIT", "CR:CJ", "CY:FPA", "CZ:DPH", "DE:MWST", "DK:CVR", "DZ:NIF",
                      "EC:RUC", "EE:KMKR", "EG:TIN", "ES:IVA", "FI:ALV", "FR:VAT", "GB:VAT", "GH:VAT", "GQ:VAT", "GR:FPA",
                      "GT:NIT", "HR:OIB", "HU:AFA", "ID:VAT", "IE:VAT", "IL:VAT", "IN:GST", "IS:VSK", "IT:IVA", "JP:CT",
                      "JP:VAT", "KE:VAT", "KR:VAT", "KW:TIN", "LI:VAT", "LK:TIN", "LT:PVM", "LU:TVA", "LV:VAT", "MA:IF",
                      "MC:TVA", "MU:TAN", "MX:RFC", "MY:GST", "MY:SST", "MY:TIN", "MY:TTX", "NG:TIN", "NL:BTW", "NO:VAT",
                      "NZ:GST", "PE:RUC", "PK:NTN", "PL:NIP", "PR:EIN", "PT:NIF", "QA:TIN", "RO:CIF", "RW:TIN", "SA:TIN",
                      "SE:VAT", "SG:GSTN", "SI:DDV", "SK:DPH", "SZ:VAT", "TD:VAT", "TH:VAT", "TN:TVA", "TR:VKN", "TS:VAT",
                      "TW:GUI", "TW:TIN", "UG:VAT", "US:EIN", "UY:RUT", "VE:RIF", "ZA:VAT", "ZW:VAT"
                    ] %>

                    <% tax_id_options.each do |code| %>
                      <option value="<%= code %>" <%= "selected" if @invoice.delivery_details_tax_id == code %>><%= code %></option>
                    <% end %>
                  </select>
                </div>


                <div class="col-md-8 mb-3">
                  <label class="form-label">Tax Number</label>
                  <input type="text" name="invoice[delivery_details_tax_number]" class="form-control" value="<%= @invoice&.delivery_details_tax_number %>">
                </div>
              </div>
            </div>


            <%= render partial: "invoices/partials/create_invoice_location_selector",
            locals: {
            type: "Ship From",
            locations: @locations_by_type["Ship From"] || [],
            selected_location_id: @invoice.ship_from_location_id
            } %>

            <%= render partial: "invoices/partials/create_invoice_location_selector",
            locals: {
            type: "Remit To",
            locations: @locations_by_type["Remit To"] || [],
            selected_location_id: @invoice.remit_to_location_id
            } %>

            <%= render partial: "invoices/partials/create_invoice_location_selector",
            locals: {
            type: "Tax Representative",
            locations: @locations_by_type["Tax Representative"] || [],
            selected_location_id: @invoice.tax_representative_location_id
            } %>


          </div>
          
          <div class="col-md-6">
            <div class="mb-3">
              <%= f.label :recipient_note, "Write a message to the recipient", class: "form-label" %>
              <%= f.text_area :recipient_note, class: "form-control", rows: 5, placeholder: "Enter your message...", value: @recipient_note.presence || @invoice&.recipient_note %>
            </div>

            <div class="form-check mb-4">
              <%= f.check_box :save_notes_for_future,
                    class: "form-check-input",
                    checked: ( @save_notes_for_future.present? ||
                      (@invoice.persisted? && @invoice.save_notes_for_future?) ||
                      (!@invoice.persisted? && @recipient_note.present?)
                    ) %>
              <%= f.label :save_notes_for_future, "Save notes for future Invoices", class: "form-check-label" %>
            </div>

            <div class="mb-3">
              <%= f.label :attachments, class: "form-label" %>
              <%= f.file_field :attachments, 
                    class: "form-control", 
                    multiple: true, 
                    accept: "image/*,application/pdf", 
                    id: "attachments" %>
              <div id="fileHelp" class="form-text">Only images (JPEG, PNG, GIF) and PDFs allowed. Max file size: 10 MB.</div>
              <div id="fileError" class="text-danger small mt-1"></div>
            </div>

            <% if @invoice.attachments.attached? %>
              <div class="mb-3">
                <label class="form-label">Existing Attachments</label>
                <div class="row">
                  <% @invoice.attachments.each_with_index do |attachment, index| %>
                    <div class="col-md-6 mb-2">
                      <div class="border p-2 rounded bg-light text-center">

                        <div class="mx-auto mb-2 rounded overflow-hidden"
                            style="width: 170px; height: 170px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9;">
                          <% if attachment.content_type.start_with?("image/") %>
                            <% begin %>
                              <%= image_tag attachment.variant(resize_to_limit: [200, 200]).processed,
                                    style: "max-width: 170px; max-height: 170px; object-fit: contain;",
                                    class: "d-block",
                                    alt: attachment.filename.to_s %>
                            <% rescue => e %>
                              <span class="text-danger small">Image preview failed</span>
                            <% end %>
                          <% else %>
                            <%= link_to attachment.filename.to_s,
                                  url_for(attachment),
                                  target: "_blank",
                                  class: "text-truncate small text-primary" %>
                          <% end %>
                        </div>

                        <div class="btn-group" role="group" aria-label="Remove Attachment Toggle" style="width: 170px;">
                          <input type="checkbox"
                                class="btn-check"
                                name="invoice[remove_attachment_ids][]"
                                value="<%= attachment.id %>"
                                id="remove_attachment_<%= index %>"
                                autocomplete="off">
                          <label class="btn btn-outline-danger" for="remove_attachment_<%= index %>">Remove</label>
                        </div>


                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>



          </div>
        </div>

        <nav class="navbar navbar-light bg-white fixed-bottom py-2" id="form_actions_fixed_navbar">
          <div class="container d-flex justify-content-between align-items-center">

            <!-- Left side -->
            <div class="d-flex gap-2">
              <% if action_name != "edit" %>
                <%= link_to "Discard", invoices_path,
                    class: "btn btn-secondary btn-md discard-btn",
                    data: { confirm: "Are you sure you want to discard this invoice?" } %>

                <%= f.submit "Save As Draft", class: "btn btn-secondary btn-md" %>
              <% else %>
                <%= link_to "Back", invoices_path, class: "btn btn-secondary btn-md" %>
              <% end %>
            </div>

            <!-- Right side -->
            <div class="d-flex gap-2">
              <button type="button" id="preview-invoice-btn" class="btn btn-outline-primary btn-md">
                Preview
              </button>

              <% if action_name != "edit" %>
                <%= f.submit "Send",
                    class: "btn btn-primary btn-md",
                    formaction: create_and_send_invoices_path,
                    formmethod: :post,
                    id: "send_invoice_btn" %>
              <% else %>
                <%= button_tag "Update", type: "submit",
                    name: "commit_action", value: "save",
                    class: "btn btn-primary btn-md" %>

                <%= button_tag "Send", type: "submit",
                    name: "commit_action", value: "send",
                    class: "btn btn-success btn-md" %>
              <% end %>
            </div>

          </div>
        </nav>




        <div id="hidden_fields_container" class="d-none">
            <%= f.hidden_field :total, id: 'total_amount_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :price_adjustments, value: @invoice.price_adjustments.to_json.html_safe, id: 'price_adjustments_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :payment_terms, value: (@invoice.payment_terms.to_h.merge(@payment_terms.to_h)).to_json.html_safe, id: 'payment_terms_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :invoice_info, value: @invoice.invoice_info.to_json.html_safe, id: 'optional_fields_json', data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :ship_from_location_id, id: "ship_from_location_id", data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :remit_to_location_id, id: "remit_to_location_id", data: { field_type: 'invoice_form_fields' } %>
            <%= f.hidden_field :tax_representative_location_id, id: "tax_representative_location_id", data: { field_type: 'invoice_form_fields' } %>

            <%= hidden_field_tag :payment_terms_json_edit, (@invoice.payment_terms.to_h.merge(@payment_terms.to_h)).to_json.html_safe, id: 'payment_terms_json_edit', data: { field_type: 'invoice_form_fields' } %>
            <%= hidden_field_tag :price_adjustments_json_edit, @invoice.price_adjustments.to_json.html_safe, id: 'price_adjustments_json_edit', data: { field_type: 'invoice_form_fields' } %>
        </div>
    <div class="card-footer bg-white pb-3">
        <button type="button" class="btn btn-primary btn-sm add-footer-toggle-btn mt-3">
          + Add footer notes
        </button>

        <div id="footer_wrapper_parent_div" class="mt-3" style="display:none">
          <div class="mb-3">
              <%= f.label :footer_notes, class: "form-label" %>
              <%= f.text_area :footer_notes, class: "form-control", rows: 5, placeholder: "Enter your message...", value: @footer_notes.presence || @invoice&.footer_notes %>
            </div>

            <div class="form-check mb-4">
              <%= f.check_box :save_footer_notes_for_future,
                    class: "form-check-input",
                    checked: ( @save_footer_notes_for_future.present? ||
                      (@invoice.persisted? && @invoice.save_footer_notes_for_future?) ||
                      (!@invoice.persisted? && defined?(@footer_notes) && @footer_notes.present?)
                    ) %>
              <%= f.label :save_footer_notes_for_future, "Save notes for future Invoices", class: "form-check-label" %>
            </div>
        </div>
    </div>
    <% end %>
  </div>
</div>

<div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Invoice Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="invoicePreviewCard"></div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    const $previewBtn = $('#preview-invoice-btn');
    const $previewCard = $('#invoicePreviewCard');
    const modal = new bootstrap.Modal($('#invoicePreviewModal')[0]);

    if ($previewBtn.length === 0) return;

    $previewBtn.on('click', function () {
      const formData = $('form').serializeArray();
      const data = {};
      $.each(formData, function (_, field) {
        data[field.name] = field.value;
      });

      // Company details
      const companyName = $('#company_name').text() || '—';
      const companyAddress = $('#company_address').text() || '';
      const companyLocation = $('#company_location').text() || '';
      const companyCountry = $('#company_country').text() || '';
      const companyNumber = $('#company_number').text().replace('Company number :', '').trim() || '-';
      const companyTaxNumber = $('#company_tax_number').text().replace('Tax number :', '').trim() || '-';

      // Basic invoice fields
      const issueDate = data['invoice[issue_date]'] || '—';
      const invoiceNumber = data['invoice[invoice_number]'] || '—';
      const currency = data['invoice[currency]'] || '—';
      const note = $('#invoice_recipient_note').val() || '';
      const footer = $('#invoice_footer_notes').val() || '';


      // Invoice info optional fields
      let optionalFieldsHtml = '';

      $('#optional_fields_container .optional-group').each(function () {
        const $group = $(this);
        const groupKey = $group.attr('data-optional-group') || '';
        const $cols = $group.find('.row > [class^="col-"]');
        let rowContent = '';

        $cols.each(function () {
          const $col = $(this);
          let label = $col.find('label').text().trim().replace(/[:]+$/, '');
          const $input = $col.find('input, select');
          let value = '';

          if ($input.is('select')) {
            value = $input.find('option:selected').text().trim();
          } else {
            value = $input.val() ? $input.val().trim() : '';
          }

          if (!value) return;

          if (!label || label === ':') label = 'Date';

          const colClasses = $col.attr('class').split(' ').filter(c => c.startsWith('col-')).join(' ');

          rowContent += `
            <div class="${colClasses} mb-2">
              <p class="mb-1 small">${label}: ${value}</p>
            </div>
          `;
        });

        if (rowContent.trim() === '') return;

        const formattedTitle = groupKey
          .replace(/_/g, ' ')
          .replace(/([A-Z])/g, ' $1')
          .replace(/\s+/g, ' ')
          .trim()
          .replace(/\b\w/g, c => c.toUpperCase());
        if (
          /delivery\s*date/i.test(formattedTitle) ||
          /payment\s*due\s*date/i.test(formattedTitle)
        ) {
          const value = $group.find('input, select').val() || '';
          if (value) {
            optionalFieldsHtml += `
              <p class="mb-1"><strong>${formattedTitle}:</strong> ${value}</p>
            `;
          }
        } else {
          optionalFieldsHtml += `
            <div class="mt-3">
              ${formattedTitle ? `<h6 class="fw-bold mb-2">${formattedTitle}</h6>` : ''}
              <div class="row">
                ${rowContent}
              </div>
            </div>
          `;
        }
      });

      // Build line items table (clean, structured, visually identical to provided example)
      let lineItems = '';

      $('#line-items tr.line-item').each(function (i) {
        const $tr = $(this);
        const $inputs = $tr.find('input, select');
        const index = $tr.data('line-index') ?? i;

        // Regular line item
        lineItems += `
          <tr class="line-item">
            <td>${$inputs.eq(0).val() || ''}</td>
            <td>${$inputs.eq(1).val() || ''}</td>
            <td>${$inputs.eq(2).val() || ''}</td>
            <td>${$inputs.eq(3).val() || ''}</td>
            <td>${$inputs.eq(4).val() || ''}</td>
            <td>${$inputs.eq(5).val() || ''}</td>
            <td class="text-end fw-semibold">${$tr.find('.total').text() || '0.00'}</td>
            <input type="hidden" name="invoice[line_items_attributes][${index}][total]" class="line-total-input" value="${$tr.find('.total').text() || '0.00'}">
          </tr>
        `;

        // Optional fields directly below each line
        $(`#line-items tr.optional-field-row[data-line-index="${index}"]`).each(function () {
          const $opt = $(this);
          const group = $opt.data('optional-group');
          const vals = {};

          // Get the actual values by logical field name
          $opt.find('input, select, span.optional-total').each(function () {
            const $el = $(this);
            const name = $el.attr('name') || '';
            let val =
              $el.is('select') ? $el.find('option:selected').text().trim() :
              $el.is('span') ? $el.text().trim() :
              $el.val();

            if (!val) return;

            // Identify key based on name pattern
            if (name.includes('discount_type') || name.includes('charge_type')) vals.type = val;
            else if (name.includes('edit_type')) vals.edit_type = val;
            else if (name.includes('unit.select')) vals.unit = val;
            else if (name.includes('quantity.text')) vals.quantity = val;
            else if (name.includes('total')) vals.total = val;
            else if (name.includes('goods_receipt_reference')) vals.reference = val;
          });

          // Render discount / charge rows
          if (group === 'discount' || group === 'charge') {
            const typeLabel = group === 'discount' ? 'Discount Type' : 'Charge Type';
            lineItems += `
              <tr class="bg-light">
                <td>
                  <label class="fw-bold small d-block">${typeLabel}</label>
                  <span class="text-muted small">${vals.type || ''}</span>
                </td>
                <td>
                  <label class="fw-bold small d-block">Edit Type</label>
                  <span class="text-muted small">${vals.edit_type || ''}</span>
                </td>
                <td>
                  <label class="fw-bold small d-block">Unit</label>
                  <span class="text-muted small">${vals.unit || ''}</span>
                </td>
                <td>
                  <label class="fw-bold small d-block">Quantity</label>
                  <span class="text-muted small">${vals.quantity || ''}</span>
                </td>
                <td></td><td></td>
                <td class="text-end fw-semibold">
                  <label class="fw-bold small d-block">Total</label>
                  <span class="text-muted small">${vals.total || '0.00'}</span>
                </td>
              </tr>
            `;
          }

          // Goods receipt reference
          if (group === 'receiptlinedocumentreference') {
            lineItems += `
              <tr class="bg-light">
                <td class="align-top">
                  <label class="fw-bold small d-block">Goods receipt reference</label>
                  <span class="text-muted small">${vals.reference || ''}</span>
                </td>
                <td></td><td></td><td></td><td></td><td></td><td></td>
              </tr>
            `;
          }
        });

      });


      // Price Adjustments section
      const adjustments = $('.discount-item');
      if (adjustments.length) {
        lineItems += `
          <tr>
            <td colspan="8" class="fw-bold text-muted table-light py-3">Price Adjustments</td>
          </tr>`;

        adjustments.each(function () {
          const $row = $(this);
          const type = $row.find('.price-adjustment-unit').val() || '';
          const desc = $row.find('.reason-code option:selected').text() || '';
          const descEdit = $row.find('.description-edit').val() || '';
          const amount = $row.find('.amount').val() || '';
          const unit = $row.find('.unit-type option:selected').text() || '';
          const total = $row.find('.total').text().replace('+', '') || '0.00';

          lineItems += `
            <tr class="bg-light">
              <td>
                <label class="fw-bold small d-block">Type</label>
                <span class="text-muted small">${type}</span>
              </td>
              <td>
                <label class="fw-bold small d-block">Description</label>
                <span class="text-muted small">${desc}</span>
              </td>
              <td>
                <label class="fw-bold small d-block">Description Edit</label>
                <span class="text-muted small">${descEdit}</span>
              </td>
              <td>
                <label class="fw-bold small d-block">Amount</label>
                <span class="text-muted small">${amount}</span>
              </td>
              <td>
                <label class="fw-bold small d-block">Unit</label>
                <span class="text-muted small">${unit}</span>
              </td>
              <td></td>
              <td class="text-end fw-semibold">
                <label class="fw-bold small d-block">Total</label>
                <span class="text-muted small">${total}</span>
              </td>
            </tr>`;
        });
      }


      // Totals
      const subtotal = $('.subtotal-amount').text() || '0.00';
      const tax = $('.total-tax-amount').text() || '0.00';
      const total = $('.grand-total-amount').text() || '0.00';

      // Payment Terms Section
      let paymentTermsHtml = '';

      const $paymentGroups = $('#payment_terms_parent_div .payment-term-group');
      if ($paymentGroups.length > 0) {
        paymentTermsHtml += `
          <h5 class="mb-3 fw-semibold">Payment Terms</h5>
          <ol class="ps-3 mb-0">
        `;

        $paymentGroups.each(function () {
          const $group = $(this);
          const title = $group.find('h5').text().trim() || 'Payment';
          const $inputs = $group.find('.payment-term-input');
          const $textOnly = $group.find('.payment-term-text-only');

          let rows = '';

          // handle input-based fields
          $inputs.each(function () {
            const $input = $(this);
            const label = $input.closest('.mb-3').find('label').text().trim().replace('(optional)', '').trim();
            const value = $input.val()?.trim();
            if (!value) return;

            rows += `
              <tr>
                <td class="text-start" style="width: 40%;">${label}</td>
                <td class="text-start">${value}</td>
              </tr>
            `;
          });

          // handle text-only fields (like Cash / Check)
          $textOnly.each(function () {
            const $txt = $(this);
            const label = $txt.closest('.mb-3').find('label').text().trim();
            const text = $txt.text().trim();
            // Show the section title even if no text content (like “Cash Payment”)
            if (!text && !rows) {
              rows = '';
            }
          });

          paymentTermsHtml += `
            <li class="mb-3">
              <h6 class="fw-bold d-inline">${title}</h6>
              ${
                rows
                  ? `
                    <table class="table table-sm table-borderless mt-2">
                      <tbody>${rows}</tbody>
                    </table>
                  `
                  : ''
              }
            </li>
          `;
        });

        paymentTermsHtml += `</ol>`;
      }

      // Delivery Details Section
      let deliveryHtml = '';

      const $deliveryDiv = $('#delivery_details_parent_div');
      if ($deliveryDiv.length > 0) {
        const getVal = (selector) => $deliveryDiv.find(selector).val()?.trim() || '';

        // Collect values
        const country = getVal('[name="invoice[delivery_details_country]"]');
        const postbox = getVal('[name="invoice[delivery_details_postbox]"]');
        const street = getVal('[name="invoice[delivery_details_street]"]');
        const number = getVal('[name="invoice[delivery_details_number]"]');
        const locality = getVal('[name="invoice[delivery_details_locality_name]"]');
        const zip = getVal('[name="invoice[delivery_details_zip_code]"]');
        const city = getVal('[name="invoice[delivery_details_city]"]');
        const gln = getVal('[name="invoice[delivery_details_gln]"]');
        const company = getVal('[name="invoice[delivery_details_company_name]"]');
        const taxId = getVal('[name="invoice[delivery_details_tax_id]"]');
        const taxNum = getVal('[name="invoice[delivery_details_tax_number]"]');

        // Build full address line
        const addressParts = [postbox, street, number, locality, zip, city, country]
          .filter(Boolean);
        const address = addressParts.join(', ');

        // If everything is empty, skip entirely
        const hasContent = address || gln || company || taxId || taxNum;

        if (hasContent) {
          deliveryHtml += `
            <h5 class="mb-3 fw-semibold">Delivery details</h5>
            <div class="row">
              ${address ? `
                <div class="col-md-12 mb-3">
                  <label class="form-label h6">Address</label>
                  <p class="form-control-plaintext">${address}</p>
                </div>` : ''}

              ${gln ? `
                <div class="col-md-12 mb-3">
                  <label class="form-label h6">GLN</label>
                  <p class="form-control-plaintext">${gln}</p>
                </div>` : ''}

              ${company ? `
                <div class="col-md-12 mb-3">
                  <label class="form-label h6">Company Name</label>
                  <p class="form-control-plaintext">${company}</p>
                </div>` : ''}

              ${(taxId || taxNum) ? `
                ${taxId ? `
                  <div class="col-md-4 mb-3">
                    <label class="form-label h6">Tax ID</label>
                    <p class="form-control-plaintext">${taxId}</p>
                  </div>` : ''}

                ${taxNum ? `
                  <div class="col-md-8 mb-3">
                    <label class="form-label h6">Tax Number</label>
                    <p class="form-control-plaintext">${taxNum}</p>
                  </div>` : ''}
              ` : ''}
            </div>
          `;
        }
      }


      // === Generic Location Details Renderer ===
      function renderLocationDetails(selector, title, outputId) {
        const $el = $(selector);
        if ($el.length === 0) return '';

        const locationName = $el.find('.location_name').text().trim();
        const companyName = $el.find('.company_name').text().trim();
        const taxNumberText = $el.find('.tax_number').text().replace(/Tax number\s*:\s*/i, '').trim();
        const street = $el.find('.street').text().trim();
        const city = $el.find('.city').text().trim();
        const country = $el.find('.country').text().trim();

        // Skip if all empty
        if (![locationName, companyName, taxNumberText, street, city, country].some(Boolean)) return '';

        // Combine address
        const streetLine = [street, city].filter(Boolean).join(', ');

        // Build HTML
        return `
          <div class="location-details mb-2" id="${outputId}">
            <hr>
            <h6>${title}</h6>
            <hr>
            ${locationName ? `<p class="fw-bold mb-1 location_name">${locationName}</p>` : ''}
            ${companyName ? `<p class="company_name mb-1">${companyName}</p>` : ''}
            ${taxNumberText ? `<p class="tax_number mb-1 text-muted">${taxNumberText}</p>` : ''}
            ${streetLine ? `<p class="street mb-0">${streetLine}</p>` : ''}
            ${country ? `<p class="country mb-0">${country}</p>` : ''}
          </div>
        `;
      }

      // === Use the same function for all three ===
      const shipFromHtml = renderLocationDetails('#ship_from_details', 'Ship From Location Details', 'ship_from_location_details');
      const remitToHtml = renderLocationDetails('#remit_to_details', 'Remit To Location Details', 'remit_to_location_details');
      const taxRepresentativeHtml = renderLocationDetails('#tax_representative_details', 'Tax Representative Location Details', 'tax_representative_location_details');

      // Build preview HTML
      const html = `
        <div class="card shadow-sm border-0" id="invoice_card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="fw-bold mb-0">Invoice Details</h4>
              <span class="badge px-3 py-2 fs-6 bg-secondary-subtle text-muted">DRAFT</span>
            </div>

            <div class="row g-4">
              <div class="col-md-6">
                <div class="p-3 rounded border bg-light-subtle">
                  <h6 class="fw-bold mb-2">${companyName}</h6>
                  <p class="mb-1 text-muted">${companyAddress}</p>
                  <p class="mb-1 text-muted">${companyLocation}</p>
                  <p class="mb-1 text-muted">${companyCountry}</p>
                  <hr>
                  <p class="mb-1 small">Company No: <strong>${companyNumber}</strong></p>
                  <p class="mb-0 small">Tax No: <strong>${companyTaxNumber}</strong></p>
                </div>
              </div>

              <div class="col-md-6">
                <div class="p-3">
                  <div class="row mb-1">
                    <div class="col-md-6">
                      <p class="mb-0"><strong>Invoice No.:</strong> ${invoiceNumber}</p>
                    </div>
                    <div class="col-md-6">
                      <p class="mb-0"><strong>Issue Date:</strong> ${issueDate}</p>
                    </div>
                  </div>
                  <p class="mb-1"><strong>Currency:</strong> ${currency}</p>
                  ${optionalFieldsHtml}
                </div>
              </div>
            </div>

            <div class="table-responsive mt-4">
              <table class="table align-middle table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Item ID</th><th>Description</th><th>Qty</th>
                    <th>Unit</th><th>Price</th><th>Tax (%)</th><th>Total</th>
                  </tr>
                </thead>
                <tbody>${lineItems}</tbody>
              </table>
            </div>

            <div class="text-end mt-4">
              <p class="mb-1">Subtotal excl. taxes: <span class="fw-semibold">${subtotal}</span></p>
              <p class="mb-1">Total taxes: <span class="fw-semibold">${tax}</span></p>
              <p class="fs-5 fw-bold mt-2">Total ${currency}: <span>${total}</span></p>
            </div>

            <hr>

            <div class="row">
              <div class="col-md-6">
                ${paymentTermsHtml || `
                  <h5 class="mb-3">Payment Terms</h5>
                  <p class="text-muted">No payment terms provided.</p>
                `}
                <hr>
                ${deliveryHtml || `
                  <h5 class="mb-3 fw-semibold">Delivery details</h5>
                  <p class="text-muted">No delivery details provided.</p>
                `}
                ${shipFromHtml || `
                  <h5 class="mb-3 fw-semibold">Ship from details</h5>
                  <p class="text-muted">No Ship From details provided.</p>
                `}
                ${remitToHtml || `
                  <h5 class="mb-3 fw-semibold">Remit to details</h5>
                  <p class="text-muted">No remit to details provided.</p>
                `}
                ${taxRepresentativeHtml  || `
                  <h5 class="mb-3 fw-semibold">Tax representative details</h5>
                  <p class="text-muted">No tax representative details provided.</p>
                `}
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <h5 class="mb-3 fw-bold">Message:</h5>
                  <p>${note.replace(/\n/g, '<br>')}</p>
                </div>
              </div>

            </div>
          </div>

          <div class="card-footer bg-white">
            <p class="mb-0">${footer.replace(/\n/g, '<br>')}</p>
          </div>
        </div>
      `;

      // Render smoothly
      $previewCard.stop(true, true).fadeOut(150, function () {
        $previewCard.html(html).fadeIn(150);
        modal.show();
      });
    });
  });
</script>