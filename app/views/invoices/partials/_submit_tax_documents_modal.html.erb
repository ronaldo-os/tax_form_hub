<div class="modal fade" id="submitTaxModal-<%= invoice.id %>" tabindex="-1" aria-labelledby="submitTaxModalLabel-<%= invoice.id %>" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow-md border-0 rounded-4">
      
      <div class="modal-header border-0">
        <h4 class="modal-title fw-bold" id="submitTaxModalLabel-<%= invoice.id %>">Submit Tax Documents</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4 pt-0">
        <%= form_with model: TaxSubmission.new, url: tax_submissions_path, local: true, multipart: true do |f| %>
          <%= f.hidden_field :invoice_id, value: invoice.id %>
          <% 
             # For purchase invoices, we want the Issuer (sale_from).
             # For sale invoices, we are the issuer, but the form asks for 'Company Name' which usually implies the counterparty?
             # Actually, looking at the layout: 
             # "Company Name" label suggests the Entity associated with the tax document.
             # If I am submitting tax docs for a Purchase I made, I am submitting them TO the Vendor (Issuer).
             # So the Company Name should be the Vendor's name.
             
             target_company = invoice.sale_from 
             if target_company.nil? && invoice.invoice_type == 'sale'
               # If sale, I am the issuer, so maybe it means my company? 
               # Or more likely, there is no 'sale_from' on a sale invoice usually (it's implicit).
               # But for Purchase invoice, sale_from is CRITICAL.
               target_company = invoice.recipient_company 
             end
          %>
          <%= f.hidden_field :company_id, value: (invoice.sale_from_id || (invoice.invoice_type == 'sale' ? invoice.recipient_company_id : nil)) %>
          <%= hidden_field_tag :redirect_url, invoices_path(request.query_parameters.merge(tab: invoice.invoice_type == 'purchase' ? 'purchases' : 'sales')) %>

          <div class="row g-3">

            <div class="col-12">
              <label class="form-label fw-semibold small text-muted" for="company_name_<%= invoice.id %>">Company Name</label>
              <input class="form-control rounded-3" type="text" value="<%= (invoice.sale_from || (invoice.invoice_type == 'sale' ? invoice.recipient_company : nil))&.name || 'Unknown Company' %>" readonly disabled>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold small text-muted" for="invoice_number_<%= invoice.id %>">Invoice Number</label>
              <input class="form-control rounded-3" type="text" value="<%= invoice.invoice_number %>" readonly disabled>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold small text-muted" for="tax_submission_form_2307_<%= invoice.id %>">Form 2307</label>
              <%= f.file_field :form_2307, class: "form-control rounded-3 file-upload-input", id: "tax_submission_form_2307_#{invoice.id}", accept: "image/*,application/pdf", required: true, data: { list_target: "#form_2307_list_#{invoice.id}", multiple: false } %>
              <small class="form-text text-muted">Only images (JPG, PNG) and PDFs are allowed.</small>
              <ul id="form_2307_list_<%= invoice.id %>" class="list-group mt-2"></ul>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold small text-muted" for="tax_submission_deposit_slip_<%= invoice.id %>">Deposit Slip or Bank Transfer Details</label>
              <%= f.file_field :deposit_slip, multiple: true, class: "form-control rounded-3 file-upload-input", id: "tax_submission_deposit_slip_#{invoice.id}", accept: "image/*,application/pdf", required: true, data: { list_target: "#deposit_slip_list_#{invoice.id}", multiple: true } %>
              <small class="form-text text-muted">You can upload multiple images or PDFs.</small>
              <ul id="deposit_slip_list_<%= invoice.id %>" class="list-group mt-2"></ul>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold small text-muted" for="tax_submission_details_<%= invoice.id %>">Additional Notes</label>
              <%= f.text_area :details, class: "form-control rounded-3", rows: 4, id: "tax_submission_details_#{invoice.id}" %>
            </div>

          </div>

          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-light border rounded-3 px-4" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Submit", class: "btn btn-primary rounded-3 px-4 fw-semibold", data: { disable_with: "Submit" } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
