<div class="container mt-5">
  <div class="card shadow-sm mb-5">
    <div class="card-body">
      <%= form_with model: @invoice, local: true, html: { multipart: true, class: "row g-3" } do |f| %>

        <h5 class="text-secondary">Invoice Details</h5>
        
        <div class="row">

          <div class="col-md-6">
            <%= f.label :to, class: "form-label" %>
            <%= f.text_field :to, class: "form-control" %>
          </div>

          <div class="col-md-6">
            <%= f.label :invoice_number, class: "form-label" %>
            <%= f.text_field :invoice_number, class: "form-control" %>

            <div class="row mt-3">
              <div class="col-md-6">
                <%= f.label :issue_date, class: "form-label" %>
                <%= f.date_field :issue_date, class: "form-control" %>
              </div>

              <div class="col-md-6">
                <%= f.label :currency, class: "form-label" %>
                <%= f.text_field :currency, class: "form-control" %>
              </div>
            </div>

            <div id="invoice_details_parent_div" class="mt-3">
              <div class="mb-3" data-optional-group="payment_due_date">
                <div class="row">
                  <div class="col-md-6">
                    <%= f.label :payment_due_date, class: "form-label" %>
                    <%= f.date_field :payment_due_date, class: "form-control" %>
                  </div>
                  <div class="col-md-6 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger ms-auto remove-group">× Remove</button>
                  </div>
                </div>
              </div>

              <div class="mb-3" data-optional-group="delivery_date">
                <div class="row">
                  <div class="col-md-6">
                    <%= f.label :delivery_date, class: "form-label" %>
                    <%= f.date_field :delivery_date, class: "form-control" %>
                  </div>
                  <div class="col-md-6 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger ms-auto remove-group">× Remove</button>
                  </div>
                </div>
              </div>

              <div id="optional_fields_container"></div>

              <div class="mt-4">
                <select id="optionalField" class="form-select">
                  <option value="">Add optional field</option>
                  <option value="customsDeclarations">Customs Declarations</option>
                  <option value="taxExchangeRateFields">Exchange rate</option>
                  <option value="transactionVatType">Transaction VAT Type</option>
                  <option value="orderReferenceId">Purchase order number</option>
                  <option value="orderReferenceIssueDate">Purchase order issue date</option>
                  <option value="billingReferenceId">Billing reference</option>
                  <option value="contractDocumentReferenceId">Contract number</option>
                  <option value="despatchDocumentReference.id">Shipping Notice Reference</option>
                  <option value="despatchDocumentReference.issueDate">Shipping Notice Issue Date</option>
                  <option value="receiptDocumentReference.id">Goods Receipt Reference</option>
                  <option value="receiptDocumentReference.issueDate">Goods Receipt Issue Date</option>
                  <option value="accountingCost">Cost center</option>
                  <option value="customerPartyContactName">Person reference</option>
                  <option value="additionalReferences[BOL ID]">Transport Reference</option>
                  <option value="BOLIssueDate">Transport Reference Issue Date</option>
                  <option value="additionalReferences[File ID]">File Id</option>
                  <option value="customerAssignedId">Customer account ID</option>
                  <option value="taxPointDate">Tax point date</option>
                  <option value="supplierCommissionNumber">Commission number of seller</option>
                  <option value="supplierPhysicalLocationValue">Data universal numbering system</option>
                  <option value="deliveryTerms">Delivery Terms</option>
                  <option value="additionalReferences[Interim Hours]">Interim Hours</option>
                  <option value="additionalReferences[BookingNumber]">Booking Number</option>
                  <option value="additionalReferences[PaymentReference]">Payment Reference</option>
                  <option value="additionalReferences[TS Clearance]">Tradeshift Clearance</option>
                  <option value="promisedDeliveryPeriod">Delivery period</option>
                  <option value="additionalReferences[Clearance Clave]">Clearance Clave</option>
                </select>
              </div>
            </div>

          </div>

        </div>

        <table class="table text-center align-middle invoice-table">
          <thead class="table-light">
            <tr>
              <th></th>
              <th>Item ID</th>
              <th>Description</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Price per unit</th>
              <th>Tax (%)</th>
              <th>Total excl. tax</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="line-items">
            <tr class="line-item">
              <td><button type="button" class="btn btn-sm btn-outline-primary toggle-dropdown">+</button></td>
              <td><input type="text" class="form-control item-id"></td>
              <td><input type="text" class="form-control description"></td>
              <td><input type="number" class="form-control quantity" value="1"></td>
              <td><input type="text" class="form-control unit" value="pcs"></td>
              <td><input type="number" class="form-control price" step="0.01"></td>
              <td><input type="number" class="form-control tax" step="0.01"></td>
              <td class="text-end total">0.00</td>
              <td><button type="button" class="btn btn-sm btn-outline-danger remove-line">&minus;</button></td>
            </tr>
            <tr class="dropdown_per_line hidden">
              <td colspan="3">
                <select name="additional_field_0" id="additional_field_0" class="no-label form-select">
                  <option value="">Add optional field</option>
                  <option value="discount">Discount</option>
                  <option value="charge">Charge (e.g. freight)</option>
                  <option value="bolid">Transport Reference</option>
                  <option value="fileid">File Id</option>
                  <option value="taxexemptionreason">Tax exemption reason</option>
                  <option value="modelname">Model name</option>
                  <option value="hsnsac">HSN/SAC</option>
                  <option value="documentreference">Purchase order number</option>
                  <option value="documentlinereference">Purchase order line number</option>
                  <option value="accountingcost">Cost center</option>
                  <option value="deliveryaddress">Delivery Address</option>
                  <option value="actualdeliverydate">Delivery Date</option>
                  <option value="buyersitemidentification">Buyer material number</option>
                  <option value="origincountry">Country of origin</option>
                  <option value="eccn">Commodity classification: ECCN</option>
                  <option value="eangtin">EAN/GTIN</option>
                  <option value="incoterms">Delivery Terms</option>
                  <option value="manufacturename">Manufacture name</option>
                  <option value="trackingid">Freight order number</option>
                  <option value="serialID">Serial number</option>
                  <option value="linenote">Notes</option>
                  <option value="despatchlinedocumentreference">Shipping Notice Reference</option>
                  <option value="despatchlineiddocumentreference">Shipping Notice Line Reference</option>
                  <option value="receiptlinedocumentreference">Goods Receipt Reference</option>
                  <option value="receiptlineiddocumentreference">Goods Receipt Line Reference</option>
                </select>
              </td>
              <td colspan="6"></td>
            </tr>
          </tbody>
        </table>

        <button type="button" id="add-line" class="btn btn-primary">ADD NEW LINE</button>

        <!-- Totals -->
        <div class="text-end">
          <div>Subtotal excl. taxes: <span id="subtotal">0.00</span></div>
          <h5>Total PHP: <strong id="total">0.00</strong></h5>
          <div class="text-muted">Total taxes: <span id="totaltax">0.00</span> PHP</div>
        </div>

        <div class="d-flex justify-content-between gap-2 mt-5">
            <%= link_to "Back", invoices_path, class: "btn btn-secondary btn-md" %>
            <%= f.submit "Create Invoice", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    let lineIndex = 1;

    // Utility Functions
    function updateRemoveButtons() {
      const isSingleRow = $('#line-items .line-item').length <= 1;
      $('#line-items .remove-line').toggle(!isSingleRow);
    }

    function getDropdownOptions() {
      const options = [
        'discount', 'charge', 'bolid', 'fileid', 'taxexemptionreason',
        'modelname', 'hsnsac', 'documentreference', 'documentlinereference',
        'accountingcost', 'deliveryaddress', 'actualdeliverydate', 'buyersitemidentification',
        'origincountry', 'eccn', 'eangtin', 'incoterms', 'manufacturename',
        'trackingid', 'serialID', 'linenote', 'despatchlinedocumentreference',
        'despatchlineiddocumentreference', 'receiptlinedocumentreference', 'receiptlineiddocumentreference'
      ];

      return options.map(opt => `<option value="${opt}">${opt.replace(/([a-z])([A-Z])/g, '$1 $2')}</option>`).join('');
    }

    function getLineItemHTML(index) {
      return `
        <tr class="line-item">
          <td><button type="button" class="btn btn-sm btn-outline-primary toggle-dropdown">+</button></td>
          <td><input type="text" class="form-control item-id"></td>
          <td><input type="text" class="form-control description"></td>
          <td><input type="number" class="form-control quantity" value="1"></td>
          <td><input type="text" class="form-control unit" value="pcs"></td>
          <td><input type="number" class="form-control price" step="0.01"></td>
          <td><input type="number" class="form-control tax" step="0.01"></td>
          <td class="text-end total">0.00</td>
          <td><button type="button" class="btn btn-sm btn-outline-danger remove-line">&minus;</button></td>
        </tr>
        <tr class="dropdown_per_line hidden">
          <td colspan="3">
            <select name="additional_field_${index}" id="additional_field_${index}" class="no-label form-select">
              <option value="">Add optional field</option>
              ${getDropdownOptions()}
            </select>
          </td>
          <td colspan="6"></td>
        </tr>
      `;
    }

    
    // Event Listeners
    $('#add-line').on('click', function () {
      $('#line-items').append(getLineItemHTML(lineIndex++));
      updateRemoveButtons();
    });

    $(document).on('click', '.toggle-dropdown', function () {
      const $btn = $(this);
      const $dropdownRow = $btn.closest('tr').next('.dropdown_per_line');
      $dropdownRow.toggle();
      $btn.text($dropdownRow.is(':visible') ? '−' : '+');
    });

    $(document).on('click', '.remove-line', function () {
      const $row = $(this).closest('tr');
      const $dropdown = $row.next('.dropdown_per_line');
      $row.remove();
      $dropdown.remove();
      recalculateTotals();
      updateRemoveButtons();
    });

    
    // Initialization
    updateRemoveButtons();

   const fieldTypeMap = {
    discount: [
      { name: "discount.discount_type", label: "Discount type", type: "select", options: [
        "Choose reason code",
        "Bank Charges",
        "Customs Duties",
        "Repair Costs",
        "Attorney Fees",
        "Taxes",
        "Late Delivery",
        "Freight Costs",
        "Reason Unknown",
        "Price Change",
        "Early payment allowance adjustment",
        "Quantity Discount",
        "Pricing Discount",
        "Volume Discount",
        "Agreed Discount",
        "Expediting fee",
        "Currency exchange differences"
      ], cols: 3 },
      { name: "discount.discount_type_edit", label: "Edit type (if needed)", type: "text", cols: 3 },
      { name: "discount.qty", label: "Quantity", type: "text", cols: 2 },
      { name: "discount.currency", label: "Currency", type: "select", options: ["PHP", "USD"], cols: 2 },
      { name: "discount.price_per_unit", label: "Price per unit", type: "text", cols: 2, disabled: true }
    ],
    charge: [
      { name: "charge.charge_type", label: "Charge type", type: "select", options: [
        "Choose reason code",
        "Bank Charges",
        "Customs Duties",
        "Repair Costs",
        "Attorney Fees",
        "Taxes",
        "Late Delivery",
        "Freight Costs",
        "Reason Unknown",
        "Price Change",
        "Early payment allowance adjustment",
        "Quantity Discount",
        "Pricing Discount",
        "Volume Discount",
        "Agreed Discount",
        "Expediting fee",
        "Currency exchange differences"
      ], cols: 3 },
      { name: "charge.charge_type_edit", label: "Edit type (if needed)", type: "text", cols: 3 },
      { name: "charge.qty", label: "Quantity", type: "text", cols: 2 },
      { name: "charge.currency", label: "Currency", type: "select", options: ["%", "PHP"], cols: 2 },
      { name: "charge.price_per_unit", label: "Price per unit", type: "text", cols: 2, disabled: true }
    ],
    bolid: [
      { name: "bolid.transport_reference", label: "Transport Reference", type: "text", cols: 4 }
    ],
    fileid: [
      { name: "fileid.file_id", label: "File ID", type: "text", cols: 4 }
    ],
    
  };

  $(document).on('change', 'select[name^="optional_fields"]', function () {
    const $select = $(this);
    const selectedValue = $select.val();
    const $rowGroup = $select.closest('tr.optional-field-row');

    if ($select.attr('name').includes('discount.discount_type')) {
      const $editInput = $rowGroup.find('input[name^="optional_fields"][name*="discount.discount_type_edit"]');
      if ($editInput.length > 0) {
        $editInput.val(selectedValue);
      }
    }

    if ($select.attr('name').includes('charge.charge_type')) {
      const $editInput = $rowGroup.find('input[name^="optional_fields"][name*="charge.charge_type_edit"]');
      if ($editInput.length > 0) {
        $editInput.val(selectedValue);
      }
    }
  });


  $(document).on('change', 'select[id^="additional_field_"]', function () {
    const $select = $(this);
    const selectedKey = $select.val();
    const selectedText = $select.find("option:selected").text();
    if (!selectedKey) return;

    const $dropdownRow = $select.closest('tr.dropdown_per_line');
    const $lineItemRow = $dropdownRow.prev('.line-item');
    const rowIndex = $('tr.line-item').index($lineItemRow);

    // Prevent duplicate field groups in the same line item
    if ($lineItemRow.siblings(`[data-optional-group="${selectedKey}"][data-line-index="${rowIndex}"]`).length > 0) {
      alert("This field group has already been added to this line item.");
      $select.val('');
      return;
    }

    const fields = fieldTypeMap[selectedKey];
    if (!fields || !Array.isArray(fields)) return;

    // Build the new row
    newRowHtml = `
      <tr class="optional-field-row" data-optional-group="${selectedKey}" data-line-index="${rowIndex}">
        <td colspan="9">
          <div class="p-2 border rounded bg-light mb-2">
            <p class="fs-5 mb-3 d-flex justify-content-between align-items-center">
              ${selectedText.toUpperCase()}
              <button type="button" class="btn btn-sm btn-outline-danger remove-group ms-2">×</button>
            </p>
            <div class="row g-3">`;

    fields.forEach(field => {
      const colClass = `col-md-${field.cols || 6} ${field.class || ''}`;
      let inputHtml = '';

      if (field.type === "select") {
        inputHtml = `<select name="optional_fields[${rowIndex}][${field.name}]" class="form-select"${field.disabled ? ' disabled' : ''}>
          ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
        </select>`;
      } else if (field.type === "textarea") {
        inputHtml = `<textarea name="optional_fields[${rowIndex}][${field.name}]" class="form-control"${field.disabled ? ' disabled' : ''}></textarea>`;
      } else {
        inputHtml = `<input type="${field.type}" name="optional_fields[${rowIndex}][${field.name}]" class="form-control"${field.disabled ? ' disabled' : ''}>`;
      }

      newRowHtml += `
        <div class="${colClass}">
          <div class="d-flex flex-column">
            <label class="form-label text-start w-100">${field.label}</label>
            ${inputHtml}
          </div>
        </div>`;
    });

    newRowHtml += `
            </div>
          </div>
        </td>
      </tr>`;

    // Insert before the dropdown row
    $dropdownRow.before(newRowHtml);
    $select.val('');
  });

  // Remove dynamically added group
  $(document).on('click', '.remove-group', function () {
    $(this).closest('tr.optional-field-row').remove();
  });



  });

</script>
