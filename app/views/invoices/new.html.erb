<div class="container mt-5">
  <div class="card shadow-sm mb-5">
    <div class="card-body">
      <%= form_with model: @invoice, local: true, html: { multipart: true, class: "" } do |f| %>

        <h5 class="text-secondary">Invoice Details</h5>
        
        <div class="row">

          <div class="col-md-6">
            <%= f.label :to, class: "form-label" %>
            <%= f.text_field :to, class: "form-control" %>
          </div>

          <div class="col-md-6">
            <%= f.label :invoice_number, class: "form-label" %>
            <%= f.text_field :invoice_number, class: "form-control" %>

            <div class="row mt-3">
              <div class="col-md-6">
                <%= f.label :issue_date, class: "form-label" %>
                <%= f.date_field :issue_date, class: "form-control" %>
              </div>

              <div class="col-md-6">
                <%= f.label :currency, class: "form-label" %>
                <%= f.text_field :currency, class: "form-control" %>
              </div>
            </div>

            <div id="invoice_details_parent_div" class="mt-3">
              <div class="mb-3 position-relative border rounded p-3 pt-3" data-optional-group="payment_due_date">
                <button type="button" class="btn btn-sm btn-outline-danger rounded position-absolute top-0 end-0 m-2 remove-group">×</button>
                <div class="row">
                  <div class="col-md-12">
                    <%= f.label :payment_due_date, class: "form-label" %>
                    <%= f.date_field :payment_due_date, class: "form-control" %>
                  </div>
                </div>
              </div>

              <div class="mb-3 position-relative border rounded p-3 pt-3" data-optional-group="delivery_date">
                <button type="button" class="btn btn-sm btn-outline-danger rounded position-absolute top-0 end-0 m-2 remove-group">×</button>
                <div class="row">
                  <div class="col-md-12">
                    <%= f.label :delivery_date, class: "form-label" %>
                    <%= f.date_field :delivery_date, class: "form-control" %>
                  </div>
                </div>
              </div>

              <div id="optional_fields_container"></div>

              <div class="mt-4 mb-4">
                <select id="optionalField" class="form-select">
                  <option value="">Add optional field</option>
                  <option value="customsDeclarations">Customs Declarations</option>
                  <option value="taxExchangeRateFields">Exchange rate</option>
                  <option value="transactionVatType">Transaction VAT Type</option>
                  <option value="orderReferenceId">Purchase order number</option>
                  <option value="orderReferenceIssueDate">Purchase order issue date</option>
                  <option value="billingReferenceId">Billing reference</option>
                  <option value="contractDocumentReferenceId">Contract number</option>
                  <option value="despatchDocumentReference.id">Shipping Notice Reference</option>
                  <option value="despatchDocumentReference.issueDate">Shipping Notice Issue Date</option>
                  <option value="receiptDocumentReference.id">Goods Receipt Reference</option>
                  <option value="receiptDocumentReference.issueDate">Goods Receipt Issue Date</option>
                  <option value="accountingCost">Cost center</option>
                  <option value="customerPartyContactName">Person reference</option>
                  <option value="additionalReferences[BOL ID]">Transport Reference</option>
                  <option value="BOLIssueDate">Transport Reference Issue Date</option>
                  <option value="additionalReferences[File ID]">File Id</option>
                  <option value="customerAssignedId">Customer account ID</option>
                  <option value="taxPointDate">Tax point date</option>
                  <option value="supplierCommissionNumber">Commission number of seller</option>
                  <option value="supplierPhysicalLocationValue">Data universal numbering system</option>
                  <option value="deliveryTerms">Delivery Terms</option>
                  <option value="additionalReferences[Interim Hours]">Interim Hours</option>
                  <option value="additionalReferences[BookingNumber]">Booking Number</option>
                  <option value="additionalReferences[PaymentReference]">Payment Reference</option>
                  <option value="additionalReferences[TS Clearance]">Tradeshift Clearance</option>
                  <option value="promisedDeliveryPeriod">Delivery period</option>
                  <option value="additionalReferences[Clearance Clave]">Clearance Clave</option>
                </select>
              </div>
            </div>

          </div>

        </div>

        <table class="table text-center align-middle invoice-table">
          <thead class="table-light">
            <tr>
              <th></th>
              <th>Item ID</th>
              <th>Description</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Price per unit</th>
              <th>Tax (%)</th>
              <th>Total excl. tax</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="line-items">
            <tr class="line-item">
              <td><button type="button" class="btn btn-sm btn-outline-primary toggle-dropdown">+</button></td>
              <td><input type="text" class="form-control item-id"></td>
              <td><input type="text" class="form-control description"></td>
              <td><input type="number" class="form-control quantity" value="1"></td>
              <td><input type="text" class="form-control unit" value="pcs"></td>
              <td><input type="number" class="form-control price" step="0.01"></td>
              <td><input type="number" class="form-control tax" step="0.01"></td>
              <td class="text-end total">0.00</td>
              <td><button type="button" class="btn btn-sm btn-outline-danger remove-line">&minus;</button></td>
            </tr>
            <tr class="dropdown_per_line hidden">
              <td colspan="3">
                <select name="additional_field_0" id="additional_field_0" class="no-label form-select">
                  <option value="">Add optional field</option>
                  <option value="discount">Discount</option>
                  <option value="charge">Charge (e.g. freight)</option>
                  <option value="bolid">Transport Reference</option>
                  <option value="fileid">File Id</option>
                  <option value="taxexemptionreason">Tax exemption reason</option>
                  <option value="modelname">Model name</option>
                  <option value="hsnsac">HSN/SAC</option>
                  <option value="documentreference">Purchase order number</option>
                  <option value="documentlinereference">Purchase order line number</option>
                  <option value="accountingcost">Cost center</option>
                  <option value="deliveryaddress">Delivery Address</option>
                  <option value="actualdeliverydate">Delivery Date</option>
                  <option value="buyersitemidentification">Buyer material number</option>
                  <option value="origincountry">Country of origin</option>
                  <option value="eccn">Commodity classification: ECCN</option>
                  <option value="eangtin">EAN/GTIN</option>
                  <option value="incoterms">Delivery Terms</option>
                  <option value="manufacturename">Manufacture name</option>
                  <option value="trackingid">Freight order number</option>
                  <option value="serialID">Serial number</option>
                  <option value="linenote">Notes</option>
                  <option value="despatchlinedocumentreference">Shipping Notice Reference</option>
                  <option value="despatchlineiddocumentreference">Shipping Notice Line Reference</option>
                  <option value="receiptlinedocumentreference">Goods Receipt Reference</option>
                  <option value="receiptlineiddocumentreference">Goods Receipt Line Reference</option>
                </select>
              </td>
              <td colspan="6"></td>
            </tr>
          </tbody>
        </table>

        <div class="row g-3 mb-3 mt-0">
          <div class="col-md-4 d-grid">
            <button type="button" id="add-discount-row" class="btn btn-outline-primary">
              Add Header Charge / Discount / Tax
            </button>
          </div>
          <div class="col-md-4 d-grid">
            <button type="button" id="add-base-quantity" class="btn btn-outline-secondary">
              Show Base Quantity Column
            </button>
          </div>
          <div class="col-md-4 d-grid">
            <button type="button" id="add-line" class="btn btn-success">
              <i class="bi bi-plus-square me-1"></i> Add New Line
            </button>
          </div>
        </div>

        

        <!-- Totals -->
        <div class="text-end">
          <div>Subtotal excl. taxes: <span id="subtotal">0.00</span></div>
          <h5>Total PHP: <strong id="total">0.00</strong></h5>
          <div class="text-muted">Total taxes: <span id="totaltax">0.00</span> PHP</div>
        </div>

        <hr>

        <div class="row">
          <div class="col-md-6">
            <div id="payment_terms_parent_div">
            </div>
            <select name="payment_terms_select" id="payment_terms_select" class="form-select mb-3" data-optional-group="0">
              <option value="">Add payment terms and means</option>
              <option value="paymentterms">Payment Terms</option>
              <option value="cash">Cash payment</option>
              <option value="check">Check</option>
              <option value="bank">Bank Account</option>
              <option value="bank_card">Bank Card</option>
              <option value="debit">Direct Debit</option>
              <option value="bic_iban">BIC + IBAN</option>
            </select>
            <div class="form-check mb-4">
              <%= f.check_box :save_payment_terms_for_future, class: "form-check-input" %>
              <%= f.label :save_payment_terms_for_future, "Save payment terms and means for future invoices", class: "form-check-label" %>
            </div>

            <hr>

            <button type="button" class="btn btn-primary btn-sm"
              data-bs-toggle="collapse"
              data-bs-target="#delivery_details_parent_div"
              aria-expanded="false"
              aria-controls="delivery_details_parent_div">
              + Delivery Details
            </button>

            <div class="collapse mt-3 border rounded p-3 pt-3" id="delivery_details_parent_div">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Delivery details</h5>
              </div>
              <div class="row">
                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label class="form-label">Country/Region</label>
                      <select name="delivery_details_country" class="form-select">
                        <option value="">- Select country/region -</option>
                        <option value="Afghanistan">Afghanistan</option>
                        <option value="Albania">Albania</option>
                        <option value="Algeria">Algeria</option>
                        <option value="Andorra">Andorra</option>
                        <option value="Angola">Angola</option>
                        <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                        <option value="Argentina">Argentina</option>
                        <option value="Armenia">Armenia</option>
                        <option value="Australia">Australia</option>
                        <option value="Austria">Austria</option>
                        <option value="Azerbaijan">Azerbaijan</option>
                        <option value="Bahamas">Bahamas</option>
                        <option value="Bahrain">Bahrain</option>
                        <option value="Bangladesh">Bangladesh</option>
                        <option value="Barbados">Barbados</option>
                        <option value="Belarus">Belarus</option>
                        <option value="Belgium">Belgium</option>
                        <option value="Belize">Belize</option>
                        <option value="Benin">Benin</option>
                        <option value="Bhutan">Bhutan</option>
                        <option value="Bolivia">Bolivia</option>
                        <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                        <option value="Botswana">Botswana</option>
                        <option value="Brazil">Brazil</option>
                        <option value="Brunei">Brunei</option>
                        <option value="Bulgaria">Bulgaria</option>
                        <option value="Burkina Faso">Burkina Faso</option>
                        <option value="Burundi">Burundi</option>
                        <option value="Cabo Verde">Cabo Verde</option>
                        <option value="Cambodia">Cambodia</option>
                        <option value="Cameroon">Cameroon</option>
                        <option value="Canada">Canada</option>
                        <option value="Central African Republic">Central African Republic</option>
                        <option value="Chad">Chad</option>
                        <option value="Chile">Chile</option>
                        <option value="China">China</option>
                        <option value="Colombia">Colombia</option>
                        <option value="Comoros">Comoros</option>
                        <option value="Congo (Congo-Brazzaville)">Congo (Congo-Brazzaville)</option>
                        <option value="Costa Rica">Costa Rica</option>
                        <option value="Croatia">Croatia</option>
                        <option value="Cuba">Cuba</option>
                        <option value="Cyprus">Cyprus</option>
                        <option value="Czech Republic">Czech Republic</option>
                        <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
                        <option value="Denmark">Denmark</option>
                        <option value="Djibouti">Djibouti</option>
                        <option value="Dominica">Dominica</option>
                        <option value="Dominican Republic">Dominican Republic</option>
                        <option value="Ecuador">Ecuador</option>
                        <option value="Egypt">Egypt</option>
                        <option value="El Salvador">El Salvador</option>
                        <option value="Equatorial Guinea">Equatorial Guinea</option>
                        <option value="Eritrea">Eritrea</option>
                        <option value="Estonia">Estonia</option>
                        <option value="Eswatini">Eswatini</option>
                        <option value="Ethiopia">Ethiopia</option>
                        <option value="Fiji">Fiji</option>
                        <option value="Finland">Finland</option>
                        <option value="France">France</option>
                        <option value="Gabon">Gabon</option>
                        <option value="Gambia">Gambia</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Germany">Germany</option>
                        <option value="Ghana">Ghana</option>
                        <option value="Greece">Greece</option>
                        <option value="Grenada">Grenada</option>
                        <option value="Guatemala">Guatemala</option>
                        <option value="Guinea">Guinea</option>
                        <option value="Guinea-Bissau">Guinea-Bissau</option>
                        <option value="Guyana">Guyana</option>
                        <option value="Haiti">Haiti</option>
                        <option value="Honduras">Honduras</option>
                        <option value="Hungary">Hungary</option>
                        <option value="Iceland">Iceland</option>
                        <option value="India">India</option>
                        <option value="Indonesia">Indonesia</option>
                        <option value="Iran">Iran</option>
                        <option value="Iraq">Iraq</option>
                        <option value="Ireland">Ireland</option>
                        <option value="Israel">Israel</option>
                        <option value="Italy">Italy</option>
                        <option value="Ivory Coast">Ivory Coast</option>
                        <option value="Jamaica">Jamaica</option>
                        <option value="Japan">Japan</option>
                        <option value="Jordan">Jordan</option>
                        <option value="Kazakhstan">Kazakhstan</option>
                        <option value="Kenya">Kenya</option>
                        <option value="Kiribati">Kiribati</option>
                        <option value="Kuwait">Kuwait</option>
                        <option value="Kyrgyzstan">Kyrgyzstan</option>
                        <option value="Laos">Laos</option>
                        <option value="Latvia">Latvia</option>
                        <option value="Lebanon">Lebanon</option>
                        <option value="Lesotho">Lesotho</option>
                        <option value="Liberia">Liberia</option>
                        <option value="Libya">Libya</option>
                        <option value="Liechtenstein">Liechtenstein</option>
                        <option value="Lithuania">Lithuania</option>
                        <option value="Luxembourg">Luxembourg</option>
                        <option value="Madagascar">Madagascar</option>
                        <option value="Malawi">Malawi</option>
                        <option value="Malaysia">Malaysia</option>
                        <option value="Maldives">Maldives</option>
                        <option value="Mali">Mali</option>
                        <option value="Malta">Malta</option>
                        <option value="Marshall Islands">Marshall Islands</option>
                        <option value="Mauritania">Mauritania</option>
                        <option value="Mauritius">Mauritius</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Micronesia">Micronesia</option>
                        <option value="Moldova">Moldova</option>
                        <option value="Monaco">Monaco</option>
                        <option value="Mongolia">Mongolia</option>
                        <option value="Montenegro">Montenegro</option>
                        <option value="Morocco">Morocco</option>
                        <option value="Mozambique">Mozambique</option>
                        <option value="Myanmar (Burma)">Myanmar (Burma)</option>
                        <option value="Namibia">Namibia</option>
                        <option value="Nauru">Nauru</option>
                        <option value="Nepal">Nepal</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="New Zealand">New Zealand</option>
                        <option value="Nicaragua">Nicaragua</option>
                        <option value="Niger">Niger</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="North Korea">North Korea</option>
                        <option value="North Macedonia">North Macedonia</option>
                        <option value="Norway">Norway</option>
                        <option value="Oman">Oman</option>
                        <option value="Pakistan">Pakistan</option>
                        <option value="Palau">Palau</option>
                        <option value="Palestine State">Palestine State</option>
                        <option value="Panama">Panama</option>
                        <option value="Papua New Guinea">Papua New Guinea</option>
                        <option value="Paraguay">Paraguay</option>
                        <option value="Peru">Peru</option>
                        <option value="Philippines">Philippines</option>
                        <option value="Poland">Poland</option>
                        <option value="Portugal">Portugal</option>
                        <option value="Qatar">Qatar</option>
                        <option value="Romania">Romania</option>
                        <option value="Russia">Russia</option>
                        <option value="Rwanda">Rwanda</option>
                        <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                        <option value="Saint Lucia">Saint Lucia</option>
                        <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
                        <option value="Samoa">Samoa</option>
                        <option value="San Marino">San Marino</option>
                        <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                        <option value="Saudi Arabia">Saudi Arabia</option>
                        <option value="Senegal">Senegal</option>
                        <option value="Serbia">Serbia</option>
                        <option value="Seychelles">Seychelles</option>
                        <option value="Sierra Leone">Sierra Leone</option>
                        <option value="Singapore">Singapore</option>
                        <option value="Slovakia">Slovakia</option>
                        <option value="Slovenia">Slovenia</option>
                        <option value="Solomon Islands">Solomon Islands</option>
                        <option value="Somalia">Somalia</option>
                        <option value="South Africa">South Africa</option>
                        <option value="South Korea">South Korea</option>
                        <option value="South Sudan">South Sudan</option>
                        <option value="Spain">Spain</option>
                        <option value="Sri Lanka">Sri Lanka</option>
                        <option value="Sudan">Sudan</option>
                        <option value="Suriname">Suriname</option>
                        <option value="Sweden">Sweden</option>
                        <option value="Switzerland">Switzerland</option>
                        <option value="Syria">Syria</option>
                        <option value="Taiwan">Taiwan</option>
                        <option value="Tajikistan">Tajikistan</option>
                        <option value="Tanzania">Tanzania</option>
                        <option value="Thailand">Thailand</option>
                        <option value="Timor-Leste">Timor-Leste</option>
                        <option value="Togo">Togo</option>
                        <option value="Tonga">Tonga</option>
                        <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                        <option value="Tunisia">Tunisia</option>
                        <option value="Turkey">Turkey</option>
                        <option value="Turkmenistan">Turkmenistan</option>
                        <option value="Tuvalu">Tuvalu</option>
                        <option value="Uganda">Uganda</option>
                        <option value="Ukraine">Ukraine</option>
                        <option value="United Arab Emirates">United Arab Emirates</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="United States of America">United States of America</option>
                        <option value="Uruguay">Uruguay</option>
                        <option value="Uzbekistan">Uzbekistan</option>
                        <option value="Vanuatu">Vanuatu</option>
                        <option value="Vatican City">Vatican City</option>
                        <option value="Venezuela">Venezuela</option>
                        <option value="Vietnam">Vietnam</option>
                        <option value="Yemen">Yemen</option>
                        <option value="Zambia">Zambia</option>
                        <option value="Zimbabwe">Zimbabwe</option>
                      </select>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label">Postbox</label>
                      <input type="text" name="delivery_details_postbox" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Street</label>
                      <input type="text" name="delivery_details_street" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label">Number</label>
                      <input type="text" name="delivery_details_number" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Locality name</label>
                      <input type="text" name="delivery_details_locality_name" class="form-control">
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label">Postal/ZIP</label>
                      <input type="text" name="delivery_details_zip_code" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">City</label>
                      <input type="text" name="delivery_details_city" class="form-control">
                    </div>

                    <div class="col-md-12 mb-3">
                      <label class="form-label">GLN</label>
                      <input type="text" name="delivery_details_gln" class="form-control">
                      <div class="form-text">
                        <a href="https://en.wikipedia.org/wiki/Global_Location_Number" target="_blank">What is a GLN?</a>
                      </div>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label class="form-label">Company Name</label>
                      <input type="text" name="delivery_details_company_name" class="form-control">
                    </div>

                    <div class="col-md-4 mb-3">
                      <label class="form-label">Tax ID</label>
                      <select name="delivery_details_tax_id" class="form-select">
                        <option value="">Tax ID</option>
                        <option value="AE:TRN">AE:TRN</option>
                        <option value="AO:VAT">AO:VAT</option>
                        <option value="AR:CUIT">AR:CUIT</option>
                        <option value="AT:MWST">AT:MWST</option>
                        <option value="AU:TFN">AU:TFN</option>
                        <option value="BB:TIN">BB:TIN</option>
                        <option value="BD:TIN">BD:TIN</option>
                        <option value="BE:BTW">BE:BTW</option>
                        <option value="BF:IFU">BF:IFU</option>
                        <option value="BG:DDS">BG:DDS</option>
                        <option value="BH:TIN">BH:TIN</option>
                        <option value="BJ:IFU">BJ:IFU</option>
                        <option value="BR:CNPJ">BR:CNPJ</option>
                        <option value="BW:VAT">BW:VAT</option>
                        <option value="CA:GST">CA:GST</option>
                        <option value="CA:QST">CA:QST</option>
                        <option value="CD:VAT">CD:VAT</option>
                        <option value="CG:VAT">CG:VAT</option>
                        <option value="CH:UID">CH:UID</option>
                        <option value="CI:VAT">CI:VAT</option>
                        <option value="CL:RUT">CL:RUT</option>
                        <option value="CM:VAT">CM:VAT</option>
                        <option value="CN:VAT">CN:VAT</option>
                        <option value="CO:NIT">CO:NIT</option>
                        <option value="CR:CJ">CR:CJ</option>
                        <option value="CY:FPA">CY:FPA</option>
                        <option value="CZ:DPH">CZ:DPH</option>
                        <option value="DE:MWST">DE:MWST</option>
                        <option value="DK:CVR">DK:CVR</option>
                        <option value="DZ:NIF">DZ:NIF</option>
                        <option value="EC:RUC">EC:RUC</option>
                        <option value="EE:KMKR">EE:KMKR</option>
                        <option value="EG:TIN">EG:TIN</option>
                        <option value="ES:IVA">ES:IVA</option>
                        <option value="FI:ALV">FI:ALV</option>
                        <option value="FR:VAT">FR:VAT</option>
                        <option value="GB:VAT">GB:VAT</option>
                        <option value="GH:VAT">GH:VAT</option>
                        <option value="GQ:VAT">GQ:VAT</option>
                        <option value="GR:FPA">GR:FPA</option>
                        <option value="GT:NIT">GT:NIT</option>
                        <option value="HR:OIB">HR:OIB</option>
                        <option value="HU:AFA">HU:AFA</option>
                        <option value="ID:VAT">ID:VAT</option>
                        <option value="IE:VAT">IE:VAT</option>
                        <option value="IL:VAT">IL:VAT</option>
                        <option value="IN:GST">IN:GST</option>
                        <option value="IS:VSK">IS:VSK</option>
                        <option value="IT:IVA">IT:IVA</option>
                        <option value="JP:CT">JP:CT</option>
                        <option value="JP:VAT">JP:VAT</option>
                        <option value="KE:VAT">KE:VAT</option>
                        <option value="KR:VAT">KR:VAT</option>
                        <option value="KW:TIN">KW:TIN</option>
                        <option value="LI:VAT">LI:VAT</option>
                        <option value="LK:TIN">LK:TIN</option>
                        <option value="LT:PVM">LT:PVM</option>
                        <option value="LU:TVA">LU:TVA</option>
                        <option value="LV:VAT">LV:VAT</option>
                        <option value="MA:IF">MA:IF</option>
                        <option value="MC:TVA">MC:TVA</option>
                        <option value="MU:TAN">MU:TAN</option>
                        <option value="MX:RFC">MX:RFC</option>
                        <option value="MY:GST">MY:GST</option>
                        <option value="MY:SST">MY:SST</option>
                        <option value="MY:TIN">MY:TIN</option>
                        <option value="MY:TTX">MY:TTX</option>
                        <option value="NG:TIN">NG:TIN</option>
                        <option value="NL:BTW">NL:BTW</option>
                        <option value="NO:VAT">NO:VAT</option>
                        <option value="NZ:GST">NZ:GST</option>
                        <option value="PE:RUC">PE:RUC</option>
                        <option value="PK:NTN">PK:NTN</option>
                        <option value="PL:NIP">PL:NIP</option>
                        <option value="PR:EIN">PR:EIN</option>
                        <option value="PT:NIF">PT:NIF</option>
                        <option value="QA:TIN">QA:TIN</option>
                        <option value="RO:CIF">RO:CIF</option>
                        <option value="RW:TIN">RW:TIN</option>
                        <option value="SA:TIN">SA:TIN</option>
                        <option value="SE:VAT">SE:VAT</option>
                        <option value="SG:GSTN">SG:GSTN</option>
                        <option value="SI:DDV">SI:DDV</option>
                        <option value="SK:DPH">SK:DPH</option>
                        <option value="SZ:VAT">SZ:VAT</option>
                        <option value="TD:VAT">TD:VAT</option>
                        <option value="TH:VAT">TH:VAT</option>
                        <option value="TN:TVA">TN:TVA</option>
                        <option value="TR:VKN">TR:VKN</option>
                        <option value="TS:VAT">TS:VAT</option>
                        <option value="TW:GUI">TW:GUI</option>
                        <option value="TW:TIN">TW:TIN</option>
                        <option value="UG:VAT">UG:VAT</option>
                        <option value="US:EIN">US:EIN</option>
                        <option value="UY:RUT">UY:RUT</option>
                        <option value="VE:RIF">VE:RIF</option>
                        <option value="ZA:VAT">ZA:VAT</option>
                        <option value="ZW:VAT">ZW:VAT</option>                      
                      </select>
                    </div>
                    <div class="col-md-8 mb-3">
                      <label class="form-label">Tax Number</label>
                      <input type="text" name="delivery_details_tax_number" class="form-control">
                    </div>
                  </div>

                </div>
            </div>

          </div>
          
          <div class="col-md-6">
            <div class="mb-3">
              <%= f.label :message, "Write a message to the recipient", class: "form-label" %>
              <%= f.text_area :message, class: "form-control", rows: 5, placeholder: "Enter your message..." %>
            </div>

            <div class="form-check mb-4">
              <%= f.check_box :save_notes_for_future, class: "form-check-input" %>
              <%= f.label :save_notes_for_future, "Save notes for future Invoices", class: "form-check-label" %>
            </div>

            <div class="mb-3">
              <%= f.label :attachments, class: "form-label" %>
              <%= f.file_field :attachments, class: "form-control", accept: "image/*,application/pdf", aria: { describedby: "fileHelp" } %>
              <div id="fileHelp" class="form-text">Only images and PDFs allowed. Max file size is 10 MB.</div>
            </div>
          </div>
        </div>


        <div class="d-flex justify-content-between gap-2 mt-5">
            <%= link_to "Back", invoices_path, class: "btn btn-secondary btn-md" %>
            <%= f.submit "Create Invoice", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    let lineIndex = 1;

    // Utility Functions
    function updateRemoveButtons() {
      const isSingleRow = $('#line-items .line-item, #line-items .discount-item').length <= 1;
      $('#line-items .remove-line').toggle(!isSingleRow);
    }

    function getDropdownOptions() {
      const options = [
        'discount', 'charge', 'bolid', 'fileid', 'taxexemptionreason',
        'modelname', 'hsnsac', 'documentreference', 'documentlinereference',
        'accountingcost', 'deliveryaddress', 'actualdeliverydate', 'buyersitemidentification',
        'origincountry', 'eccn', 'eangtin', 'incoterms', 'manufacturename',
        'trackingid', 'serialID', 'linenote', 'despatchlinedocumentreference',
        'despatchlineiddocumentreference', 'receiptlinedocumentreference', 'receiptlineiddocumentreference'
      ];

      return options.map(opt => `<option value="${opt}">${opt.replace(/([a-z])([A-Z])/g, '$1 $2')}</option>`).join('');
    }

    function getLineItemHTML(index) {
      return `
        <tr class="line-item">
          <td><button type="button" class="btn btn-sm btn-outline-primary toggle-dropdown">+</button></td>
          <td><input type="text" class="form-control item-id"></td>
          <td><input type="text" class="form-control description"></td>
          <td><input type="number" class="form-control quantity" value="1"></td>
          <td><input type="text" class="form-control unit" value="pcs"></td>
          <td><input type="number" class="form-control price" step="0.01"></td>
          <td><input type="number" class="form-control tax" step="0.01"></td>
          <td class="text-end total">0.00</td>
          <td><button type="button" class="btn btn-sm btn-outline-danger remove-line">&minus;</button></td>
        </tr>
        <tr class="dropdown_per_line hidden">
          <td colspan="3">
            <select name="additional_field_${index}" id="additional_field_${index}" class="no-label form-select">
              <option value="">Add optional field</option>
              ${getDropdownOptions()}
            </select>
          </td>
          <td colspan="6"></td>
        </tr>
      `;
    }

    
    // Event Listeners
    $('#add-line').on('click', function () {
      $('#line-items').append(getLineItemHTML(lineIndex++));
      updateRemoveButtons();
    });

    $(document).on('click', '.toggle-dropdown', function () {
      const $btn = $(this);
      const $currentLineItem = $btn.closest('tr');
      let $next = $currentLineItem.next();
      const $toggleRows = [];

      while ($next.length && !$next.hasClass('line-item')) {
        if ($next.hasClass('optional-field-row') || $next.hasClass('dropdown_per_line')) {
          $toggleRows.push($next);
        }
        $next = $next.next();
      }

      const shouldShow = $toggleRows.length > 0 && !$toggleRows[0].is(':visible');
      $toggleRows.forEach($row => $row.toggle(shouldShow));
      $btn.text(shouldShow ? '−' : '+');
    });


    $(document).on('click', '.remove-line', function () {
      const $lineItem = $(this).closest('tr');

      let $next = $lineItem.next();
      const $relatedRows = [];

      while ($next.length && !$next.hasClass('line-item')) {
        if ($next.hasClass('dropdown_per_line') || $next.hasClass('optional-field-row')) {
          $relatedRows.push($next);
        }
        $next = $next.next();
      }

      $lineItem.remove();
      $relatedRows.forEach($row => $row.remove());

      updateRemoveButtons();
    });


    
    // Initialization
    updateRemoveButtons();

   const fieldTypeMap = {
    discount: [
      { name: "discount.discount_type", label: "Discount type", type: "select", options: [
        "Choose reason code",
        "Bank Charges",
        "Customs Duties",
        "Repair Costs",
        "Attorney Fees",
        "Taxes",
        "Late Delivery",
        "Freight Costs",
        "Reason Unknown",
        "Price Change",
        "Early payment allowance adjustment",
        "Quantity Discount",
        "Pricing Discount",
        "Volume Discount",
        "Agreed Discount",
        "Expediting fee",
        "Currency exchange differences"
      ], cols: 3 },
      { name: "discount.discount_type_edit", label: "Edit type (if needed)", type: "text", cols: 3 },
      { name: "discount.qty", label: "Quantity", type: "text", cols: 2 },
      { name: "discount.currency", label: "Currency", type: "select", options: ["PHP", "USD"], cols: 2 },
      { name: "discount.price_per_unit", label: "Price per unit", type: "text", cols: 2, disabled: true }
    ],
    charge: [
      { name: "charge.charge_type", label: "Charge type", type: "select", options: [
        "Choose reason code",
        "Bank Charges",
        "Customs Duties",
        "Repair Costs",
        "Attorney Fees",
        "Taxes",
        "Late Delivery",
        "Freight Costs",
        "Reason Unknown",
        "Price Change",
        "Early payment allowance adjustment",
        "Quantity Discount",
        "Pricing Discount",
        "Volume Discount",
        "Agreed Discount",
        "Expediting fee",
        "Currency exchange differences"
      ], cols: 3 },
      { name: "charge.charge_type_edit", label: "Edit type (if needed)", type: "text", cols: 3 },
      { name: "charge.qty", label: "Quantity", type: "text", cols: 2 },
      { name: "charge.currency", label: "Currency", type: "select", options: ["%", "PHP"], cols: 2 },
      { name: "charge.price_per_unit", label: "Price per unit", type: "text", cols: 2, disabled: true }
    ],
    bolid: [
      { name: "bolid.transport_reference", label: "Transport Reference", type: "text", cols: 4 }
    ],
    fileid: [
      { name: "fileid.file_id", label: "File ID", type: "text", cols: 4 }
    ],
    taxexemptionreason: [
      { name: "taxexemptionreason.tax_exemption_reason", label: "Tax exemption reason", type: "text", cols: 4 }
    ],
    modelname: [
      { name: "modelname.model_name", label: "Model name", type: "text", cols: 4 }
    ],
    hsnsac: [
      { name: "hsnsac.hsn_sac", label: "HSN/SAC", type: "select" , options: ["HSN", "SAC"], cols: 4 },
      { name: "hsnsac.qty", label: "Quantity", type: "text", cols: 4 },
    ],
    documentreference: [
      { name: "documentreference.purchase_order_number", label: "Purchase order number", type: "text", cols: 4 }
    ],
    documentlinereference: [
      { name: "documentlinereference.purchase_order_line_number", label: "Purchase order line number", type: "text", cols: 4 }
    ],
    accountingcost: [
      { name: "accountingcost.cost_center", label: "Cost center", type: "text", cols: 4 }
    ],
    deliveryaddress: [
      {
        name: "deliveryaddress.country_origin",
        label: "Country/Region",
        type: "select",
        options: [
          "", "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina",
          "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados",
          "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana",
          "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon",
          "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Congo-Brazzaville)",
          "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Democratic Republic of the Congo", "Denmark",
          "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea",
          "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia",
          "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti",
          "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy",
          "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan",
          "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
          "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania",
          "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique",
          "Myanmar (Burma)", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger",
          "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine State",
          "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania",
          "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa",
          "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone",
          "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea",
          "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan",
          "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia",
          "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom",
          "United States of America", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
          "Yemen", "Zambia", "Zimbabwe"
        ],
        cols: 4
      },
      { name: "deliveryaddress.postbox", label: "Postbox", type: "text", cols: 4 },
      { name: "deliveryaddress.street", label: "Street", type: "text", cols: 4 },
      { name: "deliveryaddress.number", label: "Number", type: "text", cols: 4 },
      { name: "deliveryaddress.locality_name", label: "Locality name", type: "text", cols: 4 },
      { name: "deliveryaddress.postal_zipcode", label: "Postal/ZIP", type: "text", cols: 4 },
      { name: "deliveryaddress.city", label: "City", type: "text", cols: 4 },
      { name: "deliveryaddress.location_id", label: "Location Id", type: "text", cols: 4 },
    ],
    actualdeliverydate: [
      { name: "actualdeliverydate.delivery_date", label: "Delivery Date", type: "date", cols: 4 }
    ],
    buyersitemidentification: [
      { name: "buyersitemidentification.buyer_material_number", label: "Buyer material number", type: "text", cols: 4 }
    ],
    origincountry: [
      {
        name: "origincountry.country_origin",
        label: "Country of origin",
        type: "select",
        options: [
          "", "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina",
          "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados",
          "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana",
          "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon",
          "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Congo-Brazzaville)",
          "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Democratic Republic of the Congo", "Denmark",
          "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea",
          "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia",
          "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti",
          "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy",
          "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan",
          "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
          "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania",
          "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique",
          "Myanmar (Burma)", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger",
          "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine State",
          "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania",
          "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa",
          "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone",
          "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea",
          "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan",
          "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia",
          "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom",
          "United States of America", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
          "Yemen", "Zambia", "Zimbabwe"
        ],
        cols: 4
      }
    ],
    eccn: [
      { name: "eccn.commodity_classification", label: "Commodity classification: ECCN", type: "text", cols: 4 }
    ],
    eangtin: [
      { name: "eangtin.ean_gtin", label: "EAN/GTIN", type: "text", cols: 4 }
    ],
    incoterms: [
      { name: "incoterms.delivery_terms", label: "Delivery Terms", type: "text", cols: 4 }
    ],
    manufacturename: [
      { name: "manufacturename.manufacture_name", label: "Manufacture name", type: "text", cols: 4 }
    ],
    trackingid: [
      { name: "trackingid.freight_order_number", label: "Freight order number", type: "text", cols: 4 }
    ],
    serialID: [
      { name: "serialID.serial_id", label: "Serial number", type: "text", cols: 4 }
    ],
    linenote: [
      { name: "linenote.note", label: "Notes", type: "text", cols: 4 }
    ],
    despatchlinedocumentreference: [
      { name: "despatchlinedocumentreference.shipping_notice_reference", label: "Shipping Notice Reference", type: "text", cols: 4 }
    ],
    despatchlineiddocumentreference: [
      { name: "despatchlineiddocumentreference.shipping_notice_line_reference", label: "Shipping Notice Line Reference", type: "text", cols: 4 }
    ],
    receiptlinedocumentreference: [
      { name: "receiptlinedocumentreference.receipt_reference", label: "Goods Receipt Reference", type: "text", cols: 4 }
    ],
    receiptlineiddocumentreference: [
      { name: "receiptlineiddocumentreference.receipt_line_reference", label: "Goods Receipt Line Reference", type: "text", cols: 4 }
    ],
  };

  $(document).on('change', 'select[name^="optional_fields"]', function () {
    const $select = $(this);
    const selectedValue = $select.val();
    const $rowGroup = $select.closest('tr.optional-field-row');

    if ($select.attr('name').includes('discount.discount_type')) {
      const $editInput = $rowGroup.find('input[name^="optional_fields"][name*="discount.discount_type_edit"]');
      if ($editInput.length > 0) {
        $editInput.val(selectedValue);
      }
    }

    if ($select.attr('name').includes('charge.charge_type')) {
      const $editInput = $rowGroup.find('input[name^="optional_fields"][name*="charge.charge_type_edit"]');
      if ($editInput.length > 0) {
        $editInput.val(selectedValue);
      }
    }
  });


  $(document).on('change', 'select[id^="additional_field_"]', function () {
    const $select = $(this);
    const selectedKey = $select.val();
    const selectedText = $select.find("option:selected").text();
    if (!selectedKey) return;

    const $dropdownRow = $select.closest('tr.dropdown_per_line');
    const $lineItemRow = $dropdownRow.prev('.line-item');
    const rowIndex = $('tr.line-item').index($lineItemRow);

    // Prevent duplicate field groups in the same line item
    if ($lineItemRow.siblings(`[data-optional-group="${selectedKey}"][data-line-index="${rowIndex}"]`).length > 0) {
      alert("This field group has already been added to this line item.");
      $select.val('');
      return;
    }

    const fields = fieldTypeMap[selectedKey];
    if (!fields || !Array.isArray(fields)) return;

    // Build the new row
    newRowHtml = `
      <tr class="optional-field-row" data-optional-group="${selectedKey}" data-line-index="${rowIndex}">
        <td colspan="9">
          <div class="p-2 border rounded bg-light mb-2">
            <p class="fs-5 mb-3 d-flex justify-content-between align-items-center">
              ${selectedText.toUpperCase()}
              <button type="button" class="btn btn-sm btn-outline-danger remove-group ms-2">×</button>
            </p>
            <div class="row g-3">`;

    fields.forEach(field => {
      const colClass = `col-md-${field.cols || 6} ${field.class || ''}`;
      let inputHtml = '';

      if (field.type === "select") {
        inputHtml = `<select name="optional_fields[${rowIndex}][${field.name}]" class="form-select"${field.disabled ? ' disabled' : ''}>
          ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
        </select>`;
      } else if (field.type === "textarea") {
        inputHtml = `<textarea name="optional_fields[${rowIndex}][${field.name}]" class="form-control"${field.disabled ? ' disabled' : ''}></textarea>`;
      } else {
        inputHtml = `<input type="${field.type}" name="optional_fields[${rowIndex}][${field.name}]" class="form-control"${field.disabled ? ' disabled' : ''}>`;
      }

      newRowHtml += `
        <div class="${colClass}">
          <div class="d-flex flex-column">
            <label class="form-label text-start w-100">${field.label}</label>
            ${inputHtml}
          </div>
        </div>`;
    });

    newRowHtml += `
            </div>
          </div>
        </td>
      </tr>`;

    // Insert before the dropdown row
    $dropdownRow.before(newRowHtml);
    $select.val('');
  });

  // Remove dynamically added group
  $(document).on('click', '.remove-group', function () {
    $(this).closest('tr.optional-field-row').remove();
  });


  // Add header button 
  $('#add-discount-row').on('click', function () {
      const newRow = `
        <tr class="discount-item">
          <td class="align-top"></td>
          <td class="align-top">
            <select name="price_adjustment_discount" class="form-select">
              <option value="true">Discount</option>
              <option value="false">Charge</option>
              <option value="fixedtax">Fixed Tax</option>
            </select>
          </td>
          <td class="align-top">
            <input type="text" class="form-control description mb-2">
            <select name="price_adjustment_discount_type" class="form-select">
              <option value="Choose reason code" disabled selected>Choose reason code</option>
              <option value="Bank Charges">Bank Charges</option>
              <option value="Customs Duties">Customs Duties</option>
              <option value="Repair Costs">Repair Costs</option>
              <option value="Attorney Fees">Attorney Fees</option>
              <option value="Taxes">Taxes</option>
              <option value="Late Delivery">Late Delivery</option>
              <option value="Freight Costs">Freight Costs</option>
              <option value="Reason Unknown">Reason Unknown</option>
              <option value="Price Change">Price Change</option>
              <option value="Early payment allowance adjustment">Early payment allowance adjustment</option>
              <option value="Quantity Discount">Quantity Discount</option>
              <option value="Pricing Discount">Pricing Discount</option>
              <option value="Volume Discount">Volume Discount</option>
              <option value="Agreed Discount">Agreed Discount</option>
              <option value="Expediting fee">Expediting fee</option>
              <option value="Currency exchange differences">Currency exchange differences</option>
            </select>
          </td>
          <td class="align-top">
            <input type="number" class="form-control quantity" value="1">
          </td>
          <td class="align-top">
            <select name="price_adjustment_unit_type" class="form-select">
              <option value="true">%</option>
              <option value="false">PHP</option>
            </select>
          </td>
          <td class="align-top"></td>
          <td class="align-top">
            <input type="number" class="form-control tax" step="0.01">
          </td>
          <td class="align-top text-end total">0.00</td>
          <td class="align-top">
            <button type="button" class="btn btn-sm btn-outline-danger remove-line">−</button>
          </td>
        </tr>
      `;

      $('#line-items').append(newRow);
      updateRemoveButtons(); 
    });

    $('#line-items').on('click', '.remove-line', function () {
      $(this).closest('tr').remove();
      updateRemoveButtons();
    });
  });

  // Toggle base quantity column button 
  let baseQuantityVisible = false;

  $('#add-base-quantity').on('click', function () {
    baseQuantityVisible = !baseQuantityVisible;

    const $theadRow = $('.invoice-table thead tr');
    const $headerCells = $theadRow.find('th');

    if (baseQuantityVisible) {
      $(this).text('Hide Base Quantity Column');
      $headerCells.eq(5).text('Price');
      $('<th class="base-quantity-header">Price per Quantity</th>').insertAfter($headerCells.eq(5));

      $('.line-item').each(function () {
        $('<td class="base-quantity-cell"><input type="number" name="price_per_quantity" class="form-control price-per-quantity" step="0.01"></td>')
          .insertAfter($(this).find('td').eq(5));
      });

      $('.optional-field-row td[colspan]').attr('colspan', 10);
    } else {
      $(this).text('Show Base Quantity Column');
      $headerCells.eq(5).text('Price per unit');
      $('.base-quantity-header').remove();
      $('.base-quantity-cell').remove();
      $('.optional-field-row td[colspan]').attr('colspan', 9);
    }
  });

</script>
