<% content_for :page_title, "Recurring Line Items" %>
<%= javascript_include_tag "recurring_line_items", "data-turbo-track": "reload", type: "module" %>
<div class="container py-2 py-md-5">

  <!-- Tabs -->
  <ul class="custom_nav_tabs nav nav-tabs mb-3 w-100 d-flex align-items-center">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#active">Active</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#disabled">Disabled</a>
    </li>
  </ul>

  <div class="card">
    <div class="card-body p-3">

      <!-- Tab Content -->
      <div class="tab-content mt-3" id="recurringTabsContent">

        <!-- Active Recurring Table -->
        <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
          <table id="recurring-items-table" class="table table-hover table_text_centered align-middle nowrap w-100">
            <thead class="table-light">
              <tr>
                <th>Invoice #</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total</th>
                <th>Every (day)</th>
                <th>Interval</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @recurring_items.each do |item| %>
                <tr>
                    <td><%= item[:invoice_number] %></td>
                    <td><%= item[:description] %></td>
                    <td><%= item[:quantity] %></td>
                    <td><%= item[:unit] %></td>
                    <td><%= item[:price] %></td>
                    <td><%= item[:total] %></td>
                    <td><%= item[:every] %></td>
                    <td><%= item[:interval] %></td>
                    <td><%= item[:start_date] %></td>
                    <td><%= item[:end_date] %></td>
                    <td class="text-center">
                        <div class="dropdown">
                            <button class="btn btn-link text-dark p-0 fs-3 text-decoration-none"
                                    type="button"
                                    id="actionsDropdown_<%= item[:invoice_id] %>_<%= item[:line_index] %>"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                            &#8942;
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="actionsDropdown_<%= item[:invoice_id] %>_<%= item[:line_index] %>">
                            
                            <!-- Edit (open jQuery modal) -->
                            <li>
                                <a href="#" class="dropdown-item edit-btn"
                                    data-invoice-id="<%= item[:invoice_id] %>"
                                    data-line-index="<%= item[:line_index] %>"
                                    data-mode="yes"
                                    data-interval="<%= item[:interval] %>"
                                    data-every="<%= item[:every] %>"
                                    data-start-date="<%= item[:start_date] %>"
                                    data-end-date="<%= item[:end_date] %>"
                                    data-count="<%= item[:count] %>">
                                    Edit
                                </a>
                            </li>

                            <!-- Disable -->
                            <li>
                                <a href="#" class="dropdown-item disable-btn"
                                data-invoice-id="<%= item[:invoice_id] %>"
                                data-line-index="<%= item[:line_index] %>">
                                Disable
                                </a>
                            </li>

                            <!-- Delete -->
                            <li>
                                <a href="#" class="dropdown-item text-danger delete-btn"
                                data-invoice-id="<%= item[:invoice_id] %>"
                                data-line-index="<%= item[:line_index] %>">
                                Delete
                                </a>
                            </li>
                            </ul>
                        </div>
                    </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Disabled Recurring Table -->
        <div class="tab-pane fade" id="disabled" role="tabpanel" aria-labelledby="disabled-tab">
          <table id="disabled-recurring-items-table" class="table table-hover table_text_centered align-middle nowrap w-100">
            <thead class="table-light">
              <tr>
                <th>Invoice #</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total</th>
                <th>Every (day)</th>
                <th>Interval</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @disabled_recurring_items.each do |item| %>
                <tr>
                  <td><%= item[:invoice_number] %></td>
                  <td><%= item[:description] %></td>
                  <td><%= item[:quantity] %></td>
                  <td><%= item[:unit] %></td>
                  <td><%= item[:price] %></td>
                  <td><%= item[:total] %></td>
                  <td><%= item[:every] %></td>
                  <td><%= item[:interval] %></td>
                  <td><%= item[:start_date] %></td>
                  <td><%= item[:end_date] %></td>
                  <td class="text-center">
                    <div class="dropdown">
                      <button class="btn btn-link text-dark p-0 fs-3 text-decoration-none"
                              type="button" data-bs-toggle="dropdown">
                        &#8942;
                      </button>
                      <ul class="dropdown-menu">
                        <!-- Enable -->
                        <li>
                          <a href="#" class="dropdown-item enable-btn"
                             data-invoice-id="<%= item[:invoice_id] %>"
                             data-line-index="<%= item[:line_index] %>">
                            Enable
                          </a>
                        </li>
                        <!-- Delete -->
                        <li>
                          <a href="#" class="dropdown-item text-danger delete-btn"
                             data-invoice-id="<%= item[:invoice_id] %>"
                             data-line-index="<%= item[:line_index] %>">
                            Delete
                          </a>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- Edit Recurring Item Modal -->
  <div class="modal fade" id="editRecurringModal" tabindex="-1" aria-labelledby="editRecurringModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow-md border-0 rounded-4">
        <div class="modal-header border-0">
          <h4 class="modal-title fw-bold" id="editRecurringModalLabel">Edit Recurring Item</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body p-4 pt-0 pb-2">
          <form id="editRecurringForm">
            <input type="hidden" name="invoice_id" id="invoice_id">
            <input type="hidden" name="line_index" id="line_index">

            <div class="row g-3">
              <div class="col-md-6">
                <label for="mode" class="form-label fw-semibold small text-muted">Recurring</label>
                <select name="mode" id="mode" class="form-select form-select rounded-3">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="col-md-6">
                <label for="interval" class="form-label fw-semibold small text-muted">Interval</label>
                <select name="interval" id="interval" class="form-select form-select rounded-3">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>

              <div class="col-md-6">
                <label for="every" class="form-label fw-semibold small text-muted">Every (day)</label>
                <input type="number" name="every" id="every" class="form-control rounded-3">
              </div>

              <div class="col-md-6">
                <label for="start_date" class="form-label fw-semibold small text-muted">Start Date</label>
                <input type="date" name="start_date" id="start_date" class="form-control rounded-3">
              </div>

              <div class="col-md-6">
                <label for="end_date" class="form-label fw-semibold small text-muted">End Date</label>
                <input type="date" name="end_date" id="end_date" class="form-control rounded-3">
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-end gap-2 p-3">
          <button type="button" class="btn btn-light border rounded-3 px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="editRecurringForm" class="btn btn-primary rounded-3 px-4 fw-semibold">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>
