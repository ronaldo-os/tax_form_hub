<div class="card">
  <div class="card-body p-3">
  <table class="table table-hover table_text_centered align-middle nowrap submissionsTable w-100">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Company</th>
        <th>Invoice #</th>
        <th>Details</th>
        <th>Form 2307</th>
        <th>Deposit Slip</th>
        <th>Status</th>
        <th>Date Submitted</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% submissions.each do |submission| %>
        <tr>
          <td>
            <%= link_to submission.id,
                        tax_submission_path(submission, format: :js),
                        remote: true,
                        class: "text-decoration-none",
                        data: { bs_toggle: "modal", bs_target: "#submissionModal" } %>
          </td>

          <td><%= submission.company&.name || submission.company_name %></td>
          <td><%= submission.invoice&.invoice_number %></td>

          <td><%= truncate(submission.details, length: 50) %></td>

          <!-- Form 2307 -->
          <td>
            <% if submission.form_2307.attached? %>
              <button type="button" class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="modal" data-bs-target="#form2307Modal-<%= submission.id %>">
                View Form 2307
              </button>
              <!-- Form 2307 Modal -->
              <div class="modal fade" id="form2307Modal-<%= submission.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-md modal-dialog-scrollable">
                  <div class="modal-content">
                    <div class="modal-header border-0">
                      <h5 class="modal-title">Form 2307</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body d-flex justify-content-center">
                      <% if submission.form_2307.content_type.start_with?("image/") %>
                        <%= image_tag submission.form_2307, class: "img-fluid rounded border", alt: "Form 2307" %>
                      <% else %>
                        <%= link_to "View PDF", rails_blob_path(submission.form_2307, disposition: "inline"),
                              target: "_blank", class: "btn btn-sm btn-outline-secondary" %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <span class="text-muted">None</span>
            <% end %>
          </td>

          <!-- Deposit Slips -->
          <td>
            <% if submission.deposit_slip.attached? %>
              <button type="button" class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="modal" data-bs-target="#depositModal-<%= submission.id %>">
                View Deposit Slips
              </button>
              <!-- Deposit Slips Modal -->
              <div class="modal fade" id="depositModal-<%= submission.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-md modal-dialog-scrollable">
                  <div class="modal-content">
                    <div class="modal-header border-0">
                      <h5 class="modal-title">Deposit Slips</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row justify-content-center">
                        <% submission.deposit_slip.each do |file| %>
                          <div class="col-md-6 mb-3 d-flex justify-content-center">
                            <% if file.content_type.start_with?("image/") %>
                              <%= link_to url_for(file), target: "_blank" do %>
                                <%= image_tag file, class: "img-fluid rounded border", alt: "Deposit Slip" %>
                              <% end %>
                            <% else %>
                              <div class="d-flex flex-column align-items-center border p-2 rounded text-center">
                                <span><%= file.filename.to_s %></span>
                                <%= link_to "View PDF", rails_blob_path(file, disposition: "inline"),
                                      target: "_blank", class: "btn btn-sm btn-outline-secondary mt-2" %>
                              </div>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <span class="text-muted">None</span>
            <% end %>
          </td>

          <!-- Status -->
          <td>
            <% if submission.reviewed? && submission.processed? %>
              <span class="badge bg-success">Processed & Reviewed</span>
            <% elsif submission.reviewed? %>
              <span class="badge bg-info">Reviewed</span>
            <% elsif submission.processed? %>
              <span class="badge bg-warning text-dark">Processed</span>
            <% else %>
              <span class="badge bg-secondary">Pending</span>
            <% end %>
          </td>

          <td><%= submission.created_at.strftime("%B %d, %Y %I:%M %p") %></td>

          <!-- Actions Dropdown -->
          <td>
            <div class="dropdown text-center">
              <button class="btn btn-link text-dark p-0 text-decoration-none fs-3"
                      type="button" id="actionsDropdown_<%= submission.id %>"
                      data-bs-toggle="dropdown">&#8942;</button>

              <ul class="dropdown-menu" aria-labelledby="actionsDropdown_<%= submission.id %>">
                <li>
                  <%= form_with model: submission,
                                url: tax_submission_path(submission),
                                method: :patch,
                                local: true do |f| %>
                    <%= f.hidden_field :archived, value: archived_table ? false : true %>
                    <%= f.submit(archived_table ? "Unarchive" : "Archive",
                                class: "dropdown-item border-none",
                                data: { confirm: "Are you sure?" }) %>
                  <% end %>

                </li>
                <% unless submission.processed? || submission.reviewed? %>
                  <li><%= link_to "Delete", tax_submission_path(submission), method: :delete,
                                    data: { confirm: "Are you sure?" },
                                    class: "dropdown-item text-danger" %></li>
                <% end %>
              </ul>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>

  </table>
  </div>
</div>
