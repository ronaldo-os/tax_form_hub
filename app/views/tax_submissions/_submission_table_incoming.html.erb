<div class="card">
  <div class="card-body p-3">
    <table id="<%= table_id %>" class="table table-hover table_text_centered align-middle nowrap w-100">
      <thead class="table-light">
        <tr>
          <th>Transaction ID</th>
          <th>Email</th>
          <th>Company</th>
          <th>Invoice #</th>
          <th>Details</th>
          <th>Form 2307</th>
          <th>Deposit Slip</th>
          <th>Status</th>
          <th>Date Submitted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% submissions.each do |submission| %>
          <tr>
            <!-- ID -->
            <td>
              <%= link_to submission.user_transaction_id,
    tax_submission_path(submission, format: :js),
    remote: true,
    data: { turbo: false, bs_toggle: "modal", bs_target: "#submissionModal" },
    class: "text-decoration-none" %>


            </td>

            <td><%= submission.email.presence || submission.invoice&.user&.email || "N/A" %></td>
            <td><%= submission.invoice&.recipient_company&.name || submission.company&.name || submission.company_name %></td>
            <td><%= submission.invoice&.invoice_number %></td>
            <td><%= truncate(submission.details, length: 50) %></td>

            <!-- Form 2307 -->
            <td>
              <% if submission.form_2307.attached? %>
                <button type="button" class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal" data-bs-target="#form2307Modal-<%= submission.id %>">
                  View Form 2307
                </button>

                <!-- Form 2307 Modal -->
                <div class="modal fade" id="form2307Modal-<%= submission.id %>" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-md modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header border-0">
                        <h5 class="modal-title">Form 2307</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body d-flex justify-content-center">
                        <% if submission.form_2307.content_type.start_with?("image/") %>
                          <%= image_tag submission.form_2307, class: "img-fluid rounded border", alt: "Form 2307" %>
                        <% else %>
                          <%= link_to "View PDF", rails_blob_path(submission.form_2307, disposition: "inline"),
                                target: "_blank", class: "btn btn-sm btn-outline-secondary" %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% else %>
                <span class="text-muted">None</span>
              <% end %>
            </td>

            <!-- Deposit Slips -->
            <td>
              <% if submission.deposit_slip.attached? %>
                <button type="button" class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal" data-bs-target="#depositModal-<%= submission.id %>">
                  View Deposit Slips
                </button>

                <!-- Deposit Slips Modal -->
                <div class="modal fade" id="depositModal-<%= submission.id %>" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-md modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header border-0">
                        <h5 class="modal-title">Deposit Slips</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="row justify-content-center">
                          <% submission.deposit_slip.each do |file| %>
                            <div class="col-md-6 mb-3 d-flex justify-content-center">
                              <% if file.content_type.start_with?("image/") %>
                                <%= link_to url_for(file), target: "_blank" do %>
                                  <%= image_tag file, class: "img-fluid rounded border", alt: "Deposit Slip" %>
                                <% end %>
                              <% else %>
                                <div class="d-flex flex-column align-items-center border p-2 rounded text-center">
                                  <span><%= file.filename.to_s %></span>
                                  <%= link_to "View PDF", rails_blob_path(file, disposition: "inline"),
                                        target: "_blank", class: "btn btn-sm btn-outline-secondary mt-2" %>
                                </div>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% else %>
                <span class="text-muted">None</span>
              <% end %>
            </td>

            <!-- Status -->
            <td>
              <% if submission.reviewed? && submission.processed? %>
                <span class="badge bg-success">Processed & Reviewed</span>
              <% elsif submission.reviewed? %>
                <span class="badge bg-info">Reviewed</span>
              <% elsif submission.processed? %>
                <span class="badge bg-warning text-dark">Processed</span>
              <% else %>
                <span class="badge bg-secondary">Pending</span>
              <% end %>
            </td>

            <td><%= submission.created_at.strftime("%B %d, %Y %I:%M %p") %></td>

            <!-- Actions Dropdown -->
            <td style="min-width: 150px; position: relative;">
              <div class="dropdown text-center">
                <button class="btn btn-link text-dark btn-md p-0 text-decoration-none" type="button" id="statusDropdown_<%= submission.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                  &#8942;
                </button>
                <ul class="dropdown-menu text-center" aria-labelledby="statusDropdown_<%= submission.id %>">
                  <% unless archived_table %>
                    <li>
                      <%= form_with model: submission, url: tax_submission_path(submission), method: :patch, local: true do |f| %>
                        <%= f.hidden_field :reviewed, value: submission.reviewed? ? 0 : 1 %>
                        <%= f.submit submission.reviewed? ? "Unmark Reviewed" : "Mark as Reviewed", class: "border-none dropdown-item" %>
                      <% end %>
                    </li>
                    <li>
                      <%= form_with model: submission, url: tax_submission_path(submission), method: :patch, local: true do |f| %>
                        <%= f.hidden_field :processed, value: submission.processed? ? 0 : 1 %>
                        <%= f.submit submission.processed? ? "Unmark Processed" : "Mark as Processed", class: "border-none dropdown-item" %>
                      <% end %>
                    </li>
                    <li>
                      <%= form_with model: submission, url: tax_submission_path(submission), method: :patch, local: true do |f| %>
                        <%= f.hidden_field :archived, value: true %>
                        <%= f.submit "Archive", class: "dropdown-item border-none text-danger" %>
                      <% end %>
                    </li>
                  <% else %>
                    <li>
                      <%= form_with model: submission, url: tax_submission_path(submission), method: :patch, local: true do |f| %>
                        <%= f.hidden_field :archived, value: false %>
                        <%= f.submit "Unarchive", class: "dropdown-item border-none" %>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
