<% content_for :page_title, "Company Profile" %>

<% if current_user && current_user.company_id == @company.id %>
<div id="visitor-note" class="visitor-note">
  <p>
    You are currently viewing your profile, as other people see it. 
    <b>
        <%= link_to "Exit Visitor Mode", companies_path, class: "view-as-me", id: "exit-visitor-mode" %>
    </b>
  </p>
</div>
<% end %>


<div class="container py-4 py-md-5">
  <div class="row mt-4">
    <!-- Sidebar -->
    <div class="col-md-3">
      <div class="card shadow-sm rounded-3 border-0">
        <div class="card-body p-4 text-center">

          <!-- Profile Image -->
          <div class="d-flex flex-column align-items-center mb-3">
            <%= image_tag(
              @company.profile_image.attached? ? url_for(@company.profile_image) : asset_path("user_avatar_default.png"),
              class: "rounded-circle shadow-sm border",
              style: "width: 160px; height: 160px; object-fit: cover;"
            ) %>
          </div>

          <!-- Company Name + Website -->
          <h4 class="fw-bold mb-4"><%= @company.name.presence || "No company name" %></h4>

          <% if @company.website.present? %>
            <% full_url = @company.website =~ /\Ahttp(s)?:\/\// ? @company.website : "https://#{@company.website}" %>
            <p class="mb-4">
              <a href="<%= full_url %>" target="_blank" rel="noopener noreferrer" class="text-decoration-none text-primary fw-semibold">
                <%= @company.website %>
              </a>
            </p>
          <% else %>
            <p class="mb-4 text-muted">No website</p>
          <% end %>

          <!-- About -->
          <div class="mb-4 text-start">
            <small class="text-uppercase text-muted fw-semibold">About</small>
            <ul class="list-unstyled mt-3 mb-0">
              <li class="d-flex mb-2">
                <i class="fa-solid fa-laptop text-secondary icon-fixed"></i>
                <span><%= Company::INDUSTRIES.find { |label, value, _| value == @company.industry }&.first.presence || "None" %></span>
              </li>
              <li class="d-flex mb-2">
                <i class="fa-solid fa-users text-secondary icon-fixed"></i>
                <span><%= Company::SIZES.find { |label, value, _| value == @company.size }&.first.presence || "None" %></span>
              </li>
              <li class="d-flex mb-2">
                <i class="fa-solid fa-briefcase text-secondary icon-fixed"></i>
                <span><%= Company::OWNERSHIPS.find { |label, value, _| value == @company.ownership }&.first.presence || "None" %></span>
              </li>
              <li class="d-flex">
                <i class="fa-solid fa-location-dot text-secondary icon-fixed"></i>
                <span><%= @company.address.presence || "None" %></span>
              </li>
            </ul>
          </div>

          <!-- Contact -->
          <div class="mb-4 text-start">
            <small class="text-uppercase text-muted fw-semibold">Contact</small>
            <ul class="list-unstyled mt-3 mb-0">
              <li class="d-flex mb-2">
                <i class="fa-solid fa-phone text-secondary icon-fixed"></i>
                <span><%= @company.phone.presence || "None" %></span>
              </li>
              <li class="d-flex">
                <i class="fa-solid fa-envelope text-secondary icon-fixed"></i>
                <span><%= @company.email_address.presence || "None" %></span>
              </li>
            </ul>
          </div>


          <!-- Map -->
          <div>
            <div class="overflow-hidden rounded-3 shadow-sm" style="height: 150px;">
              <iframe
                width="100%"
                height="150"
                frameborder="0"
                scrolling="no"
                marginheight="0"
                marginwidth="0"
                src="https://www.openstreetmap.org/export/embed.html?bbox=121.191,14.484,121.211,14.494&amp;layer=mapnik">
              </iframe>
            </div>
            <small class="text-muted d-block mt-2" style="font-size: 11px;">
              Â© OpenStreetMap contributors
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendations -->
    <div class="col-md-9">
      <!-- Section Header -->
      <div class="card shadow-sm rounded-3 border-0 mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
          <h5 class="fw-bold text-primary mb-0">Recommendations</h5>
        </div>
      </div>

      <!-- Recommendations List -->
      <% if @company.recommendations.any? %>
        <% @company.recommendations.each do |rec| %>
          <div class="card shadow-sm rounded-3 border-0 mb-3">
            <div class="card-body">
              <p class="fw-bold mb-1"><%= rec.user.email %></p>
              <p class="text-muted small mb-3"><%= rec.created_at.strftime("%B %d, %Y") %></p>
              <p class="mb-0"><%= rec.text %></p>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-muted fst-italic">No recommendations yet.</p>
      <% end %>

      <!-- Add Recommendation -->
      <% if user_signed_in? %>
        <div class="card shadow-sm rounded-3 border-0 mt-4">
          <div class="card-body">
            <%= form_with model: [@company, Recommendation.new], local: true do |f| %>
              <div class="mb-3">
                <%= f.text_area :text, class: "form-control", rows: 4, placeholder: "Write your recommendation..." %>
              </div>
              <% if current_user && current_user.company_id == @company.id %>
                <div class="d-flex justify-content-end align-items-end">
                  <%= button_tag "Submit Recommendation",
                      type: "button",
                      id: "recommend-btn",
                      class: "btn btn-primary btn-md px-4" %>
                </div>
              <% else %>
                <div class="d-flex justify-content-end align-items-end mb-3">
                  <%= f.submit "Submit Recommendation", class: "btn btn-primary btn-md px-4" %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% else %>
        <p class="text-muted">
          Please <%= link_to "sign in", new_user_session_path, class: "fw-semibold text-primary" %> to write a recommendation.
        </p>
      <% end %>
    </div>
  </div>
</div>

